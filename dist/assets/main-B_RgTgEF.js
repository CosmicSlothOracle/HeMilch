var qe=Object.defineProperty;var Me=(d,t,e)=>t in d?qe(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var h=(d,t,e)=>Me(d,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const p of o)if(p.type==="childList")for(const x of p.addedNodes)x.tagName==="LINK"&&x.rel==="modulepreload"&&n(x)}).observe(document,{childList:!0,subtree:!0});function e(o){const p={};return o.integrity&&(p.integrity=o.integrity),o.referrerPolicy&&(p.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?p.credentials="include":o.crossOrigin==="anonymous"?p.credentials="omit":p.credentials="same-origin",p}function n(o){if(o.ep)return;o.ep=!0;const p=e(o);fetch(o.href,p)}})();const Q={left:"KeyA",right:"KeyD",up:"KeyW",down:"KeyS",attack1:"KeyE",attack2:"KeyQ",parry:"KeyR",ranged1:"KeyT",ranged2:"KeyY",transform:"KeyF",dodge:"KeyG"},z={left:"ArrowLeft",right:"ArrowRight",up:"ArrowUp",down:"ArrowDown",attack1:"Numpad1",attack2:"Numpad2",parry:"Numpad3",ranged1:"Numpad4",ranged2:"Numpad5",transform:"Numpad6",dodge:"Numpad7"};function je(d=document.body){const t={};function e(o){t[o.code]=!0}function n(o){t[o.code]=!1}return d.addEventListener("keydown",e),d.addEventListener("keyup",n),t}function de(d,t){const e=navigator.getGamepads&&navigator.getGamepads()||[],n={},o=.35;function p(x,c){if(!x)return;const i=x.buttons||[],l=x.axes||[],u=i[14]&&i[14].pressed||l[0]<-o,A=i[15]&&i[15].pressed||l[0]>o,b=i[12]&&i[12].pressed||l[1]<-.6||i[0]&&i[0].pressed,$=i[13]&&i[13].pressed||l[1]>.6,_=!!(i[5]&&i[5].pressed),P=!!(i[7]&&i[7].pressed),R=!!(i[3]&&i[3].pressed),X=!!(i[4]&&i[4].pressed),N=!!(i[6]&&i[6].pressed),V=!!(i[2]&&i[2].pressed),O=!!(i[1]&&i[1].pressed);u&&(n[c.left]=!0),A&&(n[c.right]=!0),b&&(n[c.up]=!0),$&&(n[c.down]=!0),_&&(n[c.attack1]=!0),P&&(n[c.attack2]=!0),R&&(n[c.parry]=!0),X&&(n[c.ranged1]=!0),N&&(n[c.ranged2]=!0),V&&c.transform&&(n[c.transform]=!0),O&&c.dodge&&(n[c.dodge]=!0)}return p(e[0],d),p(e[1],t),n}const pe="/qte/ninja/projectile_256x256_6.png",Rt="/qte/ninja/blast_256x256_4.png",ge="/qte/cyboard/projectile_256x256_6.png",Dt="/qte/cyboard/blast_256x256_4.png";function pt(d,t){const e=/_(\d+)\.(png|jpg|jpeg|webp)$/i.exec(d||""),n=e?parseInt(e[1],10):NaN;return Number.isFinite(n)?n:t}const vt=[{name:"ninja",displayName:"Ninja",folder:"ninja",atlasPath:"/qte/ninja",color:"#4aa3ff",emoji:"🥷",overrides:{attack1:{src:"/qte/ninja/attack_256x256_7.png",frames:7,fps:12},attack2:{src:"/qte/ninja/attack2_256x256_7.png",frames:7,fps:12},ranged1:{src:"/qte/ninja/ranged_256x256_4.png",frames:4,fps:12},ranged2:{src:"/qte/ninja/ranged2_256x256_4.png",frames:4,fps:12}}},{name:"cyboard",displayName:"Cyborg",folder:"cyboard",atlasPath:"/qte/cyboard/atlas2",color:"#ff7a7a",emoji:"🦾",overrides:{idle:{src:"/qte/cyboard/idle_256x256_4.png",frames:4,fps:6},walk:{src:"/qte/cyboard/walk_256x256_4.png",frames:4,fps:10},attack1:{src:"/qte/cyboard/attack_256x256_7.png",frames:7,fps:12},attack2:{src:"/qte/cyboard/attack2_256x256_7.png",frames:7,fps:12},ranged1:{src:"/qte/cyboard/ranged_256x256_4.png",frames:4,fps:12},ranged2:{src:"/qte/cyboard/ranged2_256x256_4.png",frames:4,fps:12},parry:{src:"",frames:6,fps:3.33},blast:{src:"/qte/cyboard/blast_256x256_4.png",frames:4,fps:12},projectile:{src:"/qte/cyboard/projectile_256x256_6.png",frames:6,fps:15,loop:!0},hurt:{src:"/qte/cyboard/hurt_256x256_4.png",frames:4,fps:15}}},{name:"laurin",displayName:"Laurin",folder:"Laurin",atlasPath:"/qte/Laurin/atlas4",color:"#9c27b0",emoji:"🧑‍💼",overrides:{projectile:{src:"",frames:6,fps:15,loop:!0},hurt:{src:"",frames:4,fps:15},defeat:{src:"",frames:4,fps:6},parry:{src:"",frames:4,fps:3.33,loop:!1}},extraAtlas:["/qte/Laurin/atlas4_1.json","/qte/Laurin/atlas4.json"]},{name:"laurin2",displayName:"Laurin (alt)",folder:"Laurin",atlasPath:"/qte/Laurin/atlas4_1",color:"#7b1fa2",emoji:"🧑‍💼",overrides:{}},{name:"granny",displayName:"Granny",folder:"granny",atlasPath:"/qte/granny/atlas3.json",color:"#6ab04c",emoji:"👵",overrides:{idle:{src:"/qte/granny/idle_256x256_6.png",frames:6,fps:6,loop:!0},spawn:{src:"/qte/granny/spawn_256x256_6.png",frames:6,fps:8},attack1:{src:"/qte/granny/attack_256x256_7.png",frames:7,fps:12},attack2:{src:"/qte/granny/attack2_256x256_7.png",frames:7,fps:12},ranged1:{src:"/qte/granny/ranged_256x256_4.png",frames:4,fps:12},ranged2:{src:"/qte/granny/ranged2_256x256_4.png",frames:4,fps:12},parry:{src:"",frames:6,fps:3.33},projectile:{src:"/qte/granny/projectile_256x256_6.png",frames:6,fps:15,loop:!0},hurt:{src:"/qte/granny/hurt_256x256_4.png",frames:4,fps:15}}}];function Yt(d){return vt.find(t=>t.name===d)||null}function Vt(d,t){const e=d.replace(/\/+$|\/+$/g,""),n={idle:{src:`/qte/${e}/idle_256x256_6.png`,frames:pt(`/qte/${e}/idle_256x256_6.png`,6),fps:6,loop:!0,frameW:256,frameH:256},walk:{src:`/qte/${e}/walk_256x256_6.png`,frames:pt(`/qte/${e}/walk_256x256_6.png`,6),fps:10,loop:!0,frameW:256,frameH:256},jump:{src:`/qte/${e}/jump_256x256_8.png`,frames:pt(`/qte/${e}/jump_256x256_8.png`,8),fps:12,loop:!1,frameW:256,frameH:256},attack1:{src:`/qte/${e}/attack_256x256_7.png`,frames:pt(`/qte/${e}/attack_256x256_7.png`,7),fps:12,loop:!1,frameW:256,frameH:256},attack2:{src:`/qte/${e}/attack2_256x256_7.png`,frames:pt(`/qte/${e}/attack2_256x256_7.png`,7),fps:12,loop:!1,frameW:256,frameH:256},parry:{src:"",frames:6,fps:3.33,loop:!1,frameW:256,frameH:256},spawn:{src:`/qte/${e}/spawn_256x256_6.png`,frames:pt(`/qte/${e}/spawn_256x256_6.png`,6),fps:8,loop:!1,frameW:256,frameH:256},defeat:{src:`/qte/${e}/defeat_256x256_4.png`,frames:pt(`/qte/${e}/defeat_256x256_4.png`,4),fps:6,loop:!1,frameW:256,frameH:256},projectile:{src:`/qte/${e}/projectile_256x256_6.png`,frames:pt(`/qte/${e}/projectile_256x256_6.png`,6),fps:15,loop:!0,frameW:256,frameH:256},ranged1:{src:`/qte/${e}/ranged_256x256_4.png`,frames:pt(`/qte/${e}/ranged_256x256_4.png`,4),fps:12,loop:!1,frameW:256,frameH:256},ranged2:{src:`/qte/${e}/ranged2_256x256_4.png`,frames:pt(`/qte/${e}/ranged2_256x256_4.png`,4),fps:12,loop:!1,frameW:256,frameH:256},blast:{src:`/qte/${e}/blast_256x256_4.png`,frames:pt(`/qte/${e}/blast_256x256_4.png`,4),fps:12,loop:!1,frameW:256,frameH:256},hurt:{src:`/qte/${e}/hurt_256x256_4.png`,frames:pt(`/qte/${e}/hurt_256x256_4.png`,4),fps:15,loop:!1,frameW:256,frameH:256}};if(t)for(const o of Object.keys(t))n[o]={...n[o],...t[o]};return{frameW:256,frameH:256,animations:n}}async function At(d){const t=Date.now(),e=[];d.match(/\.json$/i)?e.push(d):(e.push(`${d}/atlas.json`),e.push(`${d}.json`),e.push(`${d}/atlas2.json`),e.push(`${d}/atlas2`),e.push(`${d}/atlas3.json`),e.push(`${d}/atlas4.json`),e.push(`${d}/atlas4_1.json`),e.push(`${d}/atlas4-1.json`),e.push(`${d}/atlas3`),e.push(`${d}/atlas4`),e.push(`${d}/Atlas.json`),e.push(`${d}.Atlas.json`),e.push(`${d}/Atlas2.json`),e.push(`${d}/Atlas2`));let n=null,o=null;const p=[];for(const H of e){const L=`${H}?v=${t}`;p.push(L),console.log(`[atlas] Trying ${L}`);try{const K=await fetch(L);if(!K.ok){console.log(`[atlas] ${L} responded ${K.status}`);continue}const et=K.headers.get("content-type")||"",U=await K.text();if(et.includes("text/html")||U.trim().startsWith("<!DOCTYPE")){console.warn(`[atlas] ${L} looks like HTML (skipping)`);continue}n=U,o=L.replace(/\?v=\d+$/,""),console.log(`[atlas] Loaded JSON from ${L} (len=${n.length})`);break}catch(K){console.warn(`[atlas] fetch failed for ${L}`,K);continue}}if(!n||!o)throw new Error(`Atlas JSON not found. Tried: ${p.join(", ")}`);console.log(`[atlas] JSON response length: ${n.length}, starts with: ${n.substring(0,100)}`);let x;try{x=JSON.parse(n)}catch(H){throw console.error("[atlas] JSON parse error:",H),console.error("[atlas] Invalid JSON text:",n.substring(0,200)),H}const c=x.frames,i=x.meta||{},u=`${o.replace(/\/[^/]*$/,"")}/${i.image||"atlas.png"}?v=${t}`;console.log(`[atlas] Loading image ${u}`);const A=await He(u),b={};for(const H in c){const L=H.replace(/_\d+$/,""),K=/_(\d+)$/.exec(H),et=K?parseInt(K[1],10):0;b[L]||(b[L]=[]);const U=c[H].frame;b[L][et]={x:U.x,y:U.y,w:U.w,h:U.h}}for(const H in b)b[H].sort((L,K)=>{const et=Object.keys(c).find(it=>it.startsWith(`${H}_`)&&c[it].frame.x===L.x&&c[it].frame.y===L.y),U=Object.keys(c).find(it=>it.startsWith(`${H}_`)&&c[it].frame.x===K.x&&c[it].frame.y===K.y);if(et&&U){const it=parseInt(et.split("_")[1],10),ct=parseInt(U.split("_")[1],10);return it-ct}return 0});if(x.animations){const H={};for(const L in x.animations){const K=x.animations[L];H[L]=K.map(et=>{const U=c[et];return U?{x:U.frame.x,y:U.frame.y,w:U.frame.w,h:U.frame.h}:{x:0,y:0,w:256,h:256}})}Object.assign(b,H)}const $=Object.keys(b)[0],_=$?b[$][0]:{w:64,h:64},P=i.tileSize&&Array.isArray(i.tileSize)&&i.tileSize.length>=2?i.tileSize:[_.w,_.h],R=P[0],X=P[1],N=x.animations||{},V=x.animationSettings||{},O={};for(const H of Object.keys(b)){const L=b[H].filter(ct=>ct!=null),K=N[H]||N[H+""],et=V[H]||{},U=et.fps||(K&&K.fps?K.fps:i.fps||12),it=et.loop!==void 0?et.loop:K&&typeof K.loop=="boolean"?K.loop:!0;O[H]={frames:L,fps:U,loop:it},H==="parry"&&console.log("[atlas] PARRY ANIMATION LOADED:",{state:H,frames:L.length,rects:L,fps:U,loop:it,providedAnims:N[H]}),H==="projectile3"&&console.log("[atlas] PROJECTILE3 ANIMATION LOADED:",{state:H,frames:L.length,rects:L,fps:U,loop:it,providedAnims:N[H]})}return{image:A,animations:O,frameW:R,frameH:X,frames:c,meta:i}}function He(d){return new Promise((t,e)=>{const n=new Image;n.onload=()=>t(n),n.onerror=e,n.src=d})}function Fe(d,t){try{const e=/_(\d+)\.(png|jpg|jpeg|webp)$/i.exec(d),n=e?parseInt(e[1],10):NaN;return Number.isFinite(n)?n:t}catch{return t}}class jt{constructor(t,e,n,o={}){h(this,"defaultImage");h(this,"frameW");h(this,"frameH");h(this,"animations");h(this,"state","idle");h(this,"frame",0);h(this,"acc",0);h(this,"fps",12);h(this,"loop",!0);h(this,"warnedStates",new Set);h(this,"waitingForCompletion",!1);h(this,"completionDelay",0);this.defaultImage=t,this.frameW=e,this.frameH=n,this.animations={};for(const p of Object.keys(o)){const x=o[p],c={src:x.src||"",frames:x.frames??Fe(x.src||"",1),fps:x.fps??12,loop:x.loop??!0,frameW:x.frameW??e,frameH:x.frameH??n,image:x.image,rects:x.rects,imageLoaded:x.imageLoaded,imageBroken:x.imageBroken};if(c.src&&!c.image){const i=new Image;c.image=i,c.imageLoaded=!1,c.imageBroken=!1,i.onload=()=>c.imageLoaded=!0,i.onerror=()=>c.imageBroken=!0,i.src=c.src}this.animations[p]=c}}setState(t){if(this.state===t){t==="parry"&&console.debug(`[SpriteAnimator] SKIPPED setState("${t}") - already in this state`);return}this.state=t,this.frame=0,this.acc=0,this.waitingForCompletion=!1,this.completionDelay=0,this.warnedStates.delete(t);const e=this.animations[t];e?(this.fps=typeof e.fps=="number"?e.fps:this.fps,this.loop=typeof e.loop=="boolean"?e.loop:this.loop,(t==="parry"||t==="attack"||t==="defeat")&&console.debug(`[SpriteAnimator] State changed to "${t}" `+JSON.stringify({frames:e.frames,fps:e.fps,loop:e.loop,hasImage:!!e.image,hasRects:!!e.rects,imageLoaded:e.imageLoaded,imageBroken:e.imageBroken}))):console.warn(`[SpriteAnimator] Animation "${t}" not found! Available: ${Object.keys(this.animations).join(",")}`)}update(t){const e=this.animations[this.state];if(!e)return;const n=1/(e.fps||this.fps);if(this.waitingForCompletion){this.completionDelay-=t,this.completionDelay<=0&&(this.waitingForCompletion=!1,this.state!=="defeat"&&this.setState("idle"));return}for(this.acc+=t;this.acc>=n;)if(this.acc-=n,this.frame++,this.frame>=e.frames)if(e.loop)this.frame=0;else{this.frame=e.frames-1,this.waitingForCompletion=!0,this.completionDelay=n;break}}draw(t,e,n,o,p,x=!1){const c=this.animations[this.state],i=c&&c.image||this.defaultImage;if(!c||!i||!i.complete||i.naturalWidth===0){this.warnedStates.has(this.state)||(console.warn(`[SpriteAnimator] FALLBACK GREY BOX for state "${this.state}":`,{hasAnimation:!!c,hasImage:!!i,declaredImageBrokenFlag:c==null?void 0:c.imageBroken,imageComplete:i==null?void 0:i.complete,naturalWidth:i==null?void 0:i.naturalWidth,imageSrc:i==null?void 0:i.src,animationSrc:c==null?void 0:c.src}),this.warnedStates.add(this.state)),t.fillStyle="#666",t.fillRect(e,n,o,p);return}let l=this.frame*(c.frameW||this.frameW),u=0,A=c.frameW||this.frameW,b=c.frameH||this.frameH;if(c.rects&&c.rects.length>0){const $=c.rects[this.frame%c.rects.length];l=$.x,u=$.y,A=$.w,b=$.h}x?(t.save(),t.translate(e+o,0),t.scale(-1,1),t.drawImage(i,l,u,A,b,0,n,o,p),t.restore()):t.drawImage(i,l,u,A,b,e,n,o,p)}}class ue{constructor(t,e,n,o,p,x,c,i=null,l=null,u=0,A=0){h(this,"x");h(this,"y");h(this,"vx");h(this,"vy");h(this,"alive",!0);h(this,"age",0);h(this,"lifespan",1);h(this,"owner");h(this,"anim");h(this,"displayW",256);h(this,"displayH",256);h(this,"applyKnockbackOnHit",!0);this.x=t,this.y=e,this.vx=n,this.vy=u!==0?u:o,this.gravity=A||0,this.owner=p;const b={src:x,frames:c,fps:15,loop:!0,frameW:256,frameH:256};i&&l&&(b.image=i,b.rects=l,b.frames=l.length,b.imageLoaded=!0,b.imageBroken=!1,b.src=""),this.anim=new jt(i,256,256,{fly:b}),this.anim.setState("fly"),this.anim.frame=0}update(t){this.age+=t;const e=this.gravity||0;e!==0&&(this.vy+=e*t),this.x+=this.vx*t,this.y+=this.vy*t,this.anim.update(t),this.age>=this.lifespan&&(this.alive=!1)}draw(t){t.save();const e=Math.max(0,1-this.age/this.lifespan);t.globalAlpha=e,this.anim.animations.fly,this.anim.draw(t,this.x,this.y,this.displayW,this.displayH,this.vx<0),t.restore(),t.globalAlpha=1}rect(){return{x:this.x,y:this.y,w:this.displayW,h:this.displayH}}}class Gt{constructor(t,e,n,o,p=null,x=null){h(this,"x");h(this,"y");h(this,"alive",!0);h(this,"timer");h(this,"anim");h(this,"w",256);h(this,"h",256);this.x=t,this.y=e,this.timer=o/12;const c={src:n,frames:o,fps:12,loop:!1,frameW:256,frameH:256};p&&x?(c.image=p,c.rects=x,c.frames=x.length,c.imageLoaded=!0,c.imageBroken=!1,c.src=""):console.warn(`[qte] BLAST ATLAS MISSING: atlasImage=${!!p}, atlasRects=${!!x}`),this.anim=new jt(p,256,256,{boom:c}),this.anim.setState("boom"),this.anim.animations.boom}update(t){this.timer-=t,this.anim.update(t),this.timer<=0&&(this.alive=!1)}draw(t){this.anim.draw(t,this.x-this.w*.5,this.y-this.h*.5,this.w,this.h)}}class ee{constructor(t){h(this,"ctx");h(this,"canvasW");h(this,"canvasH");h(this,"x");h(this,"y");h(this,"w",256);h(this,"h",256);h(this,"vx",0);h(this,"vy",0);h(this,"facing",1);h(this,"hp",3);h(this,"maxHp",3);h(this,"damagePercent",0);h(this,"stocks",3);h(this,"onGround",!1);h(this,"state","idle");h(this,"name");h(this,"color");h(this,"keys");h(this,"anim");h(this,"attacking1",!1);h(this,"attacking2",!1);h(this,"parrying",!1);h(this,"ranging1",!1);h(this,"ranging2",!1);h(this,"attack1Launched",!1);h(this,"attack2Launched",!1);h(this,"laurinAttack1ProjectileLaunched",!1);h(this,"ranged1Launched",!1);h(this,"ranged2Launched",!1);h(this,"ranged2Hold",!1);h(this,"hurt",!1);h(this,"flying",!1);h(this,"flyHold",!1);h(this,"flySpeed",300);h(this,"_prevAttack2",!1);h(this,"_grannyR2Active",!1);h(this,"_playReverse",null);h(this,"allowGroundCollision",!0);h(this,"muzzleOffset");h(this,"_lastAnimFrame",{});h(this,"_lastLoggedFlyFrame",-1);h(this,"_flyLogAcc",0);h(this,"_frozen",!1);h(this,"attack1Timer",0);h(this,"attack2Timer",0);h(this,"ranged1Timer",0);h(this,"ranged2Timer",0);h(this,"parryTimer",0);h(this,"parryFreezeTimer",0);h(this,"parryCooldown",0);h(this,"stunTimer",0);h(this,"hurtTimer",0);h(this,"parryConsumed",!1);h(this,"parryDurationDefault",.25);h(this,"stunned",!1);h(this,"launchedFromHit",!1);h(this,"shouldRemove",!1);h(this,"devSpawnFlashTimer",0);h(this,"devSpawnFlashPos",{x:0,y:0});this.x=t.x,this.y=t.y,this.color=t.color,this.keys=t.keys,this.name=t.name,this.characterId=t.characterId||null,this.ctx=t.ctx,this.canvasW=t.canvasWidth,this.canvasH=t.canvasHeight,this.muzzleOffset=t.muzzleOffset??{x:36,y:-48};const e=new Image;e.src=t.spriteConfig.animations.idle.src,this.anim=new jt(e,t.spriteConfig.frameW,t.spriteConfig.frameH,t.spriteConfig.animations),this.anim.setState("idle"),this.maxHp=this.hp}rect(){const t=Math.max(1,Math.floor(this.w*.5)),e=Math.max(1,Math.floor(this.h*.5)),n=this.x+Math.floor((this.w-t)*.5),o=this.y+Math.floor((this.h-e)*.5);return{x:n,y:o,w:t,h:e}}hitbox(){if(this.state==="attack1"||this.state==="attack2"){const n=this.facing>0?this.x+this.w-10:this.x-50,o=this.y+this.h*.55-40*.5;return{x:n,y:o,w:60,h:40}}return null}update(t,e,n,o=[]){var c;const p=!!e[this.keys.dodge];if(p&&!this.flying){this.flying=!0,this.state="fly";try{const i=this.anim.animations.fly;if(i&&(i.rects&&i.rects.length>0||i.frames&&i.frames>0||i.src)){this.anim.setState("fly");try{const l=this.anim.animations.fly;l&&l.rects&&l.rects.length>0&&(!l.frames||l.frames===0)&&(l.frames=l.rects.length,l.fps||(l.fps=12),l.loop=!0)}catch{}}else this.anim.animations.jump?this.anim.setState("jump"):this.anim.setState("idle")}catch{try{this.anim.setState("fly")}catch{}}this.vy=0,this.onGround=!1;try{this.anim.frame=0}catch{}}if(this.flying){try{this.anim.update(t)}catch{}let i=0,l=0;e[this.keys.left]?(i=-this.flySpeed,this.facing=-1):e[this.keys.right]?(i=this.flySpeed,this.facing=1):i=0,e[this.keys.up]?l=-this.flySpeed:e[this.keys.down]?l=this.flySpeed:l=0,this.vx=i,this.vy=l,this.x+=this.vx*t,this.y+=this.vy*t;try{this._flyLogAcc+=t;const u=this.anim.animations[this.anim.state],A=this.anim.frame;this._flyLogAcc>=.25&&(this._flyLogAcc=0,this._lastLoggedFlyFrame=A,console.debug("[qte][fly] state=",this.anim.state,"frame=",A,"frames=",u==null?void 0:u.frames,"fps=",u==null?void 0:u.fps,"loop=",u==null?void 0:u.loop,"hasRects=",!!(u!=null&&u.rects)))}catch{}try{const u=this.anim.animations.fly;if(u){const A=u.rects&&u.rects.length?u.rects.length:u.frames||1,b=Math.max(0,A-2);if(!this.flyHold&&this.anim.state==="fly"&&this.anim.frame>=b){if(!this.anim.animations.fly_hold){const $={src:u.src||"",frames:0,fps:u.fps||12,loop:!0,frameW:u.frameW||256,frameH:u.frameH||256,image:u.image};u.rects&&u.rects.length>0?($.rects=u.rects.slice(b),$.frames=$.rects.length):$.frames=(u.frames||1)-b,this.anim.animations.fly_hold=$}this.flyHold=!0,this.anim.setState("fly_hold");try{this.anim.update(1/(((c=this.anim.animations.fly_hold)==null?void 0:c.fps)||12))}catch{}}}}catch{}p||(this.flying=!1,this.flyHold=!1,this.onGround?Math.abs(this.vx)>1?this.setState("walk"):this.setState("idle"):this.setState("jump"))}else this.stunTimer<=0&&!this.launchedFromHit&&(e[this.keys.left]?(this.vx=-150,this.facing=-1):e[this.keys.right]?(this.vx=150,this.facing=1):this.vx=0),this.onGround&&e[this.keys.up]&&(this._jumpStartTime||(this._jumpStartTime=performance.now()),this.vy=-350,this.onGround=!1),!e[this.keys.up]&&this._jumpStartTime&&(performance.now()-this._jumpStartTime<100&&this.vy<0&&(this.vy=-175),this._jumpStartTime=null),this.vy+=900*t,this.x+=this.vx*t,this.y+=this.vy*t;const x=1200;if(this.onGround&&!this.launchedFromHit)if(Math.abs(this.vx)>.001){const i=Math.sign(this.vx)*x*t;Math.abs(i)>=Math.abs(this.vx)?this.vx=0:this.vx-=i}else this.vx=0;if(this.allowGroundCollision&&this.y+this.h>=this.canvasH-40&&(this.y=this.canvasH-40-this.h,this.vy=0,this.launchedFromHit&&(this.vx=0,this.launchedFromHit=!1,this.hurt=!1,this.hurtTimer=0,this.stunTimer=0,this.state!=="defeat"&&!this.parrying&&this.setState("idle")),this.onGround=!0),!this.flying){if(e[this.keys.parry]&&!this.parrying&&!this.attacking1&&!this.attacking2&&!this.ranging1&&!this.ranging2&&!this.hurt&&this.parryCooldown<=0&&(this.parrying=!0,this.setState("parry"),this.parryTimer=this.parryDurationDefault,this.parryConsumed=!1,this.parryCooldown=3,console.debug(`[Fighter] ${this.name} started parry - state: ${this.state}, anim.state: ${this.anim.state}`)),this.parrying&&(this.parryTimer-=t,this.parryTimer<=0&&(this.parrying=!1,this.setState("idle"),console.debug(`[Fighter] ${this.name} parry ended - returning to idle`))),this.parryCooldown>0&&(this.parryCooldown=Math.max(0,this.parryCooldown-t)),e[this.keys.attack1]&&!this.attacking1&&!this.parrying){this.attacking1=!0,this.state="attack1",this.anim.setState("attack1"),this.attack1Timer=.35,this.attack1Launched=!1;try{const i=this.characterId;if(i&&String(i).toLowerCase()==="laurin"){this.laurinAttack1ProjectileLaunched=!1;try{const l=this.anim.animations.attack1,u=l&&l.rects&&l.rects.length?l.rects.length:l&&l.frames||0,A=l&&l.fps||12;console.debug("[qte][laurin] attack1 started - reset projectile flag",{totalFrames:u,fps:A})}catch{}}}catch{}}if(this.attacking1&&(this.attack1Timer-=t,this.attack1Timer<=0&&(this.attacking1=!1)),e[this.keys.attack2]&&!this.attacking2&&!this.parrying)if(this.characterId==="granny"){this.attacking2=!0,this.state="attack2",this.anim.setState("attack2"),this.attack2Timer=.35,this.attack2Launched=!1,this._grannyR2Active=!0;try{const l=this.anim.animations.attack2;if(l&&l.rects&&l.rects.length>0){const u=l.rects||[],A=(_,P)=>u.find(R=>R.x===_&&R.y===P),b=[[1536,1280],[1792,1280],[0,1536],[256,1536],[512,1536],[768,1536]],$=b.map(([_,P])=>A(_,P)).filter(Boolean);$.length===b.length&&(this.anim.animations.attack1alt={src:l.src||"",frames:$.length,fps:l.fps||12,loop:!1,frameW:l.frameW||256,frameH:l.frameH||256,image:l.image,rects:$})}}catch{}try{const l=this.anim.animations.attack2;if(l&&l.rects&&l.rects.length>0){const u=l.rects[l.rects.length-1];this.anim.animations.idle_from_attack2_last={src:l.src||"",frames:1,fps:1,loop:!0,frameW:l.frameW||256,frameH:l.frameH||256,image:l.image,rects:[u]},this.anim.setState("idle_from_attack2_last")}}catch{}!this.anim.animations.walking&&this.anim.animations.walk&&(this.anim.animations.walking=this.anim.animations.walk)}else this.attacking2=!0,this.state="attack2",this.anim.setState("attack2"),this.attack2Timer=.35,this.attack2Launched=!1;this.attacking2&&(this.attack2Timer-=t,this.attack2Timer<=0&&(this.attacking2=!1));try{if(this.characterId==="granny"){if(this._grannyR2Active&&!this.attacking2&&(this._grannyR2Active=!1,this.anim.animations.idle&&this.anim.setState("idle"),this.anim.animations.attack2)){const l=this.anim.animations.attack2;this.anim.setState("attack2"),this.anim.frame=l.frames-1,this._playReverse={remaining:l.frames,fps:l.fps||12}}if(this._playReverse){const l=this._playReverse;if(l.remaining>0){const u=1/l.fps;for(l.acc=(l.acc||0)+t;l.acc>=u&&l.remaining>0;)l.acc-=u,this.anim.frame=Math.max(0,this.anim.frame-1),l.remaining-=1;l.remaining<=0&&(delete this._playReverse,this.anim.animations.idle&&this.anim.setState("idle"))}}}}catch{}if(e[this.keys.ranged1]&&!this.ranging1&&!this.parrying&&(this.ranging1=!0,this.state="ranged1",this.anim.setState("ranged1"),this.ranged1Timer=.4,this.ranged1Launched=!1),this.ranging1&&(this.ranged1Timer-=t,this.handleRangedAttack("ranged1",this.ranged1Launched,i=>{this.ranged1Launched=i},n,o),this.ranged1Timer<=0&&(this.ranging1=!1)),e[this.keys.ranged2]&&!this.ranging2&&!this.parrying&&(this.ranging2=!0,this.ranged2Hold=!1,this.state="ranged2",this.anim.setState("ranged2"),this.ranged2Timer=.4,this.ranged2Launched=!1),this.ranging2)if(this.handleRangedAttack("ranged2",this.ranged2Launched,i=>{this.ranged2Launched=i},n,o),e[this.keys.ranged2])try{const i=this.anim.animations.ranged2;if(i){const l=i.rects&&i.rects.length?i.rects.length:i.frames||1,u=Math.max(0,l-3);if(!this.ranged2Hold&&this.anim.state==="ranged2"&&this.anim.frame>=u){if(!this.anim.animations.ranged2_hold){const A={src:i.src||"",frames:0,fps:i.fps||12,loop:!0,frameW:i.frameW||256,frameH:i.frameH||256,image:i.image};if(i.rects&&i.rects.length>0){const b=Math.max(0,i.rects.length-3);A.rects=i.rects.slice(b),A.frames=A.rects.length}else{const b=Math.max(0,(i.frames||1)-3);A.frames=(i.frames||1)-b}this.anim.animations.ranged2_hold=A}this.ranged2Hold=!0,this.anim.setState("ranged2_hold")}}}catch{}else(this.ranged2Hold||this.ranging2)&&(this.ranging2=!1,this.ranged2Hold=!1)}this.hurt&&(this.hurtTimer-=t,this.hurtTimer<=0&&(this.hurt=!1,this.state!=="defeat"&&!this.parrying&&(this.onGround?Math.abs(this.vx)>1?this.setState("walk"):this.setState("idle"):this.setState("jump")))),!this.flying&&!this.attacking1&&!this.attacking2&&!this.ranging1&&!this.ranging2&&!this.hurt&&!this.parrying&&this.state!=="defeat"&&(this.onGround?Math.abs(this.vx)>1?this.setState("walk"):this.setState("idle"):this.setState("jump")),this.anim.update(t);try{const i=this.characterId;if(i&&String(i).toLowerCase()==="laurin"&&this.anim.state==="attack1"&&!this.laurinAttack1ProjectileLaunched){const l=this.anim.animations.attack1,u=l&&l.rects&&l.rects.length?l.rects.length:l&&l.frames||0;if(u>0&&this.anim.frame>=4){this.laurinAttack1ProjectileLaunched=!0,console.debug("[qte][laurin] attack1 final frame - spawning projectile3",{frame:this.anim.frame,total:u});const A=256,b=256,$=this.muzzleOffset||{x:36,y:-48},_=this.x+this.w*.5+$.x*this.facing,P=this.y+this.h*.5+$.y,R=Math.round(_-A*.5),X=Math.round(P-b*.5),N=600,V=this.facing>0?N:-N;let O=null,H=null,L=1;if(this.anim.animations.projectile3&&this.anim.animations.projectile3.rects&&this.anim.animations.projectile3.rects.length>0)O=this.anim.animations.projectile3.image,H=this.anim.animations.projectile3.rects,L=H.length,console.debug("[qte][laurin] using projectile3 atlas frames (final-frame spawn)");else{console.warn("[qte][laurin] projectile3 atlas frames not found on final-frame spawn; aborting spawn to avoid fallback"),this.laurinAttack1ProjectileLaunched=!1;return}const K=this.name==="P1"?pe:ge,et=new ue(R,X,V,0,this,K,L,O,H,0,0);et.applyKnockbackOnHit=!1;const U=this.facing>0?this.canvasW-R:R;et.lifespan=Math.min(1.2,Math.abs(U/N)),n.push(et),this.devSpawnFlashTimer=.25,this.devSpawnFlashPos={x:R+A*.5,y:X+b*.5}}}}catch(i){console.error("[qte][laurin] error spawning projectile3 on final frame",i)}try{this.devSpawnFlashTimer>0&&(this.devSpawnFlashTimer=Math.max(0,this.devSpawnFlashTimer-t))}catch{}try{if(this.state==="defeat"){const i=this.anim.animations.defeat,l=i&&i.rects&&i.rects.length?i.rects.length:i&&i.frames||0;if(l>0&&this.anim.frame>=l-1){this._frozen=!0;try{this.name!=="P1"&&(this.shouldRemove=!0)}catch{}}}}catch{}}draw(){this.anim.draw(this.ctx,this.x,this.y,this.w,this.h,this.facing<0);try{if(this.hp>0&&this.maxHp>0){const n=this.x+(this.w-80)*.5,o=this.y-12;this.ctx.fillStyle="#222",this.ctx.fillRect(n,o,80,8);const p=Math.max(0,Math.min(1,this.hp/this.maxHp));this.ctx.fillStyle="#ff4444",this.ctx.fillRect(n+1,o+1,78*p,6),this.ctx.strokeStyle="#000",this.ctx.lineWidth=2,this.ctx.strokeRect(n,o,80,8)}}catch{}try{if(this.devSpawnFlashTimer>0&&this.devSpawnFlashPos){const t=Math.max(0,Math.min(1,this.devSpawnFlashTimer/.25));this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=`rgba(255,216,0,${t})`,this.ctx.arc(this.devSpawnFlashPos.x,this.devSpawnFlashPos.y,20*t,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}}catch{}}landAt(t){this.y=t,this.vy=0,this.launchedFromHit&&(this.vx=0,this.launchedFromHit=!1,this.hurt=!1,this.hurtTimer=0,this.stunTimer=0,this.state!=="defeat"&&!this.parrying&&this.setState("idle")),this.onGround=!0}setState(t){this.state!==t&&(this.state=t,this.anim.setState(t))}handleRangedAttack(t,e,n,o,p=[]){var $,_;const x=(($=this.anim.animations[t])==null?void 0:$.frames)||4,c=Math.min(2,x-1),i=t,l=this._lastAnimFrame[i]??-1,u=l>this.anim.frame||l===((_=this.anim.animations[t])==null?void 0:_.frames)-1&&this.anim.frame===0;if(this._lastAnimFrame[i]=this.anim.frame,this.characterId==="laurin"&&t==="ranged1"?!e&&this.anim.state===t&&this.anim.frame===c:!e&&this.anim.state===t&&this.anim.frame===c||u){n(!0);const P=256,R=256,X=this.muzzleOffset||{x:36,y:-48},N=this.x+this.w*.5+X.x*this.facing,V=this.y+this.h*.5+X.y,O=Math.round(N-P*.5),H=Math.round(V-R*.5),L=600,K=this.facing>0?L:-L,et=this.name==="P1"?pe:ge;let U=null,it=null,ct=6;t==="ranged1"&&this.anim&&this.anim.animations.projectile2&&this.anim.animations.projectile2.rects?(U=this.anim.animations.projectile2.image,it=this.anim.animations.projectile2.rects,ct=this.anim.animations.projectile2.rects.length,console.log(`[qte] Projectile using atlas frames 'projectile2' from ${this.name} (${ct} frames)`)):this.anim&&this.anim.animations.projectile&&this.anim.animations.projectile.rects?(U=this.anim.animations.projectile.image,it=this.anim.animations.projectile.rects,ct=this.anim.animations.projectile.rects.length,console.log(`[qte] Projectile using atlas frames from ${this.name} (${ct} frames)`)):(console.log(`[qte] Projectile: No atlas frames for 'projectile' in ${this.name}, falling back to individual image.`),this.anim&&this.anim.animations.projectile&&this.anim.animations.projectile.image&&(U=this.anim.animations.projectile.image,console.log(`[qte] Projectile: using per-animation image for ${this.name}`)));let s=0,T=0;try{const Ht=this.characterId;t==="ranged1"&&(Ht==="laurin"||Ht==="Laurin")&&(s=-220,T=900,console.log("[qte] spawning arcing projectile for Laurin"))}catch{}const mt=new ue(O,H,K,0,this,et,ct,U,it,s,T);(t==="ranged1"||t==="ranged2")&&(mt.applyKnockbackOnHit=!1);const Ct=this.facing>0?this.canvasW-O:O;mt.lifespan=Math.min(1.2,Math.abs(Ct/L)),o.push(mt)}}takeDamage(t=1){if(!(this.hp<=0||this.state==="defeat")&&(this.hp=Math.max(0,this.hp-t),this.hurt=!0,this.hurtTimer=.3,this.anim.animations.hurt&&this.anim.setState("hurt"),this.hp<=0)){this.state="defeat";try{this.anim.animations.defeat?this.anim.setState("defeat"):this.anim.setState("idle")}catch{}this.maxHp=0}}receiveHit(t,e=120,n=1,o){if(this.state==="defeat")return;this.damagePercent+=t;const p=this.damagePercent,x=6*n,i=e+p*x+p*p/(30+p),l=typeof o=="number"?Math.cos(o)<0:!1,u=.2;if(p<30){const A=.12*n,b=.12*n,$=typeof o=="number"?o:this.facing>0?Math.PI:0,_=Math.cos($)*i*A*u,P=-Math.sin($)*i*b*u;this.vx+=_,this.vy+=P,this.stunTimer=Math.max(this.stunTimer,.25*n),this.hurt=!0,this.hurtTimer=.3,this.anim.animations.hurt&&this.anim.setState("hurt")}else{const b=1+Math.min(Math.max((p-30)/70,0),1)*2,$=-350,_=150,P=$*b*u,R=l?1:-1,X=_*b*R*u;this.vx=X,this.vy=P,this.onGround=!1,this.launchedFromHit=!0,this.hurt=!0,this.hurtTimer=.45,this.anim.animations.hurt&&this.anim.setState("hurt"),this.stunTimer=Math.max(this.stunTimer,.5*n)}}isDefeated(){return this.hp<=0}}class Le{constructor(){h(this,"modal");h(this,"canvas");h(this,"ctx");h(this,"currentAnimationIndex",0);h(this,"animations",[]);h(this,"animators",new Map);h(this,"availableCharacters",[]);h(this,"atlasCanvas");h(this,"atlasCtx");h(this,"timelineCanvas");h(this,"timelineCtx");h(this,"isVisible",!1);h(this,"animationId",null);h(this,"currentCharacter","ninja");h(this,"characterSelect");h(this,"frameSequencer");h(this,"frameSequencerLabel");h(this,"isPlaying",!0);h(this,"currentFrame",0);this.createModal(),this.setupEventListeners(),this.populateCharacterSelect().then(()=>this.loadAnimations())}createModal(){this.modal=document.createElement("div"),this.modal.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      z-index: 10000;
      font-family: Arial, sans-serif;
    `;const t=document.createElement("div");t.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #1a1a1a;
      border: none;
      border-radius: 0;
      padding: 20px;
      overflow: auto;
      display: flex;
      flex-direction: column;
    `;const e=document.createElement("div");e.style.cssText=`
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    `;const n=document.createElement("h2");n.textContent="QTE Animation Viewer",n.style.cssText=`
      color: #fff;
      margin: 0;
      font-size: 24px;
    `;const o=document.createElement("button");o.textContent="×",o.style.cssText=`
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 4px;
      width: 30px;
      height: 30px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    `,o.onclick=()=>this.hide(),e.appendChild(n),e.appendChild(o);const p=document.createElement("div");p.style.cssText=`
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      align-items: center;
    `;const x=document.createElement("label");x.textContent="Character:",x.style.cssText="color: #fff; font-weight: bold;",this.characterSelect=document.createElement("select");const c=this.characterSelect;c.style.cssText=`
      background: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 5px 10px;
      font-size: 14px;
    `,c.innerHTML='<option value="">(discovering...)</option>',c.onchange=X=>{this.currentCharacter=X.target.value,this.loadAnimations(),this.currentAnimationIndex=0,this.updateDisplay()},p.appendChild(x),p.appendChild(c);const i=document.createElement("div");i.style.cssText=`
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    `,this.canvas=document.createElement("canvas"),this.canvas.width=512,this.canvas.height=512,this.canvas.style.cssText=`
      border: 2px solid #555;
      border-radius: 4px;
      background: #000;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
      width: 512px;
      height: 512px;
    `,this.ctx=this.canvas.getContext("2d");const l=document.createElement("div");l.id="animation-info",l.style.cssText=`
      color: #fff;
      text-align: center;
      font-size: 16px;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    `;const u=document.createElement("div");u.style.cssText=`
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
    `;const A=document.createElement("button");A.textContent="◀ Previous",A.style.cssText=`
      background: #444;
      color: white;
      border: 1px solid #666;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
    `,A.onclick=()=>this.previousAnimation();const b=document.createElement("button");b.textContent="Next ▶",b.style.cssText=`
      background: #444;
      color: white;
      border: 1px solid #666;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
    `,b.onclick=()=>this.nextAnimation();const $=document.createElement("button");$.id="play-pause-btn",$.textContent="⏸ Pause",$.style.cssText=`
      background: #0066cc;
      color: white;
      border: 1px solid #0088ff;
      border-radius: 4px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
    `,$.onclick=()=>this.togglePlayPause();const _=document.createElement("div");_.style.cssText=`
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      margin: 0 20px;
    `,this.frameSequencerLabel=document.createElement("div"),this.frameSequencerLabel.style.cssText=`
      color: #fff;
      font-size: 12px;
      font-weight: bold;
    `,this.frameSequencerLabel.textContent="Frame: 0/0",this.frameSequencer=document.createElement("input"),this.frameSequencer.type="range",this.frameSequencer.min="0",this.frameSequencer.max="0",this.frameSequencer.value="0",this.frameSequencer.style.cssText=`
      width: 200px;
      height: 20px;
      background: #333;
      outline: none;
      border-radius: 10px;
    `,this.frameSequencer.oninput=()=>this.onFrameSequencerChange(),_.appendChild(this.frameSequencerLabel),_.appendChild(this.frameSequencer),u.appendChild(A),u.appendChild($),u.appendChild(_),u.appendChild(b);const P=document.createElement("div");P.id="animation-list",P.style.cssText=`
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #333;
      border-radius: 4px;
      background: #222;
      flex: 1;
    `,i.appendChild(this.canvas),i.appendChild(l),i.appendChild(u);const R=document.createElement("div");R.style.cssText=`
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 10px;
    `,this.atlasCanvas=document.createElement("canvas"),this.atlasCanvas.width=400,this.atlasCanvas.height=400,this.atlasCanvas.style.cssText=`
      border: 1px solid #333;
      background: #000;
      image-rendering: pixelated;
      width: 400px;
      height: 400px;
    `,this.atlasCtx=this.atlasCanvas.getContext("2d"),this.timelineCanvas=document.createElement("canvas"),this.timelineCanvas.width=500,this.timelineCanvas.height=60,this.timelineCanvas.style.cssText=`
      border: 1px solid #333;
      background: #111;
      width: 500px;
      height: 60px;
    `,this.timelineCtx=this.timelineCanvas.getContext("2d"),R.appendChild(this.atlasCanvas),R.appendChild(this.timelineCanvas),i.appendChild(R),i.appendChild(P),t.appendChild(e),t.appendChild(p),t.appendChild(i),this.modal.appendChild(t),document.body.appendChild(this.modal)}async discoverAtlasDirectories(){try{const e=await fetch("/qte/atlas_index.json");if(e.ok){const n=await e.json();if(n&&n.characters)return Object.keys(n.characters)}}catch(e){console.debug("[AnimationViewer] atlas_index.json not found or invalid, falling back to directory scan",e)}const t=["ninja","cyboard","granny","Laurin"];try{const e=await fetch("/qte/");if(!e.ok)return t;const n=await e.text(),o=/href\s*=\s*"([^"']+)"/g,p=new Set;let x;for(;(x=o.exec(n))!==null;){const i=x[1],l=/(?:\/qte\/)?([^\/]+)\/?$/.exec(i);if(l){const u=l[1];/\.[a-zA-Z0-9]{1,5}$/.test(u)||p.add(u)}}const c=Array.from(p).filter(Boolean);return c.length?c:t}catch(e){return console.warn("[AnimationViewer] discoverAtlases failed, using fallback",e),t}}async populateCharacterSelect(){const t=this.characterSelect;t.innerHTML="";const e=await this.discoverAtlasDirectories();e.forEach(n=>{const o=document.createElement("option");o.value=n,o.textContent=n,t.appendChild(o)}),e.includes(this.currentCharacter)?t.value=this.currentCharacter:e.length>0&&(this.currentCharacter=e[0],t.value=this.currentCharacter)}setupEventListeners(){document.addEventListener("keydown",t=>{if(this.isVisible)switch(t.key){case"Escape":this.hide();break;case"ArrowLeft":this.previousAnimation();break;case"ArrowRight":this.nextAnimation();break;case" ":t.preventDefault(),this.togglePlayPause();break}})}async loadAnimations(){try{console.log(`[AnimationViewer] Loading animations for ${this.currentCharacter}`);const t=await this.loadAllAtlasesForCharacter(this.currentCharacter);console.log("[AnimationViewer] Atlas loaded:",{atlasCount:t.length,totalAnimations:t.reduce((e,n)=>e+Object.keys(n.animations||{}).length,0)}),this.animations=[],this.animators.clear();for(const e of t)this.processAtlas(e);console.log(`[AnimationViewer] Total animations loaded: ${this.animations.length}`),this.updateAnimationList(),this.updateDisplay()}catch(t){console.error("Failed to load animations:",t)}}async loadAllAtlasesForCharacter(t){const e=[];try{const o=await fetch("/qte/atlas_index.json");if(o.ok){const p=await o.json();if(p.characters&&p.characters[t]){const x=p.characters[t].json||[];for(const c of x)try{const i=await At(`/qte/${t}/${c.replace(".json","")}`);e.push(i),console.log(`[AnimationViewer] Loaded ${t}/${c}`)}catch(i){console.warn(`[AnimationViewer] Failed to load ${t}/${c}:`,i)}return e}}}catch{console.debug("[AnimationViewer] atlas_index.json not available, using fallback")}const n=["atlas.json","atlas2.json","atlas3.json","atlas4.json","atlas4_1.json","Atlas.json"];for(const o of n)try{const p=await At(`/qte/${t}/${o.replace(".json","")}`);e.push(p),console.log(`[AnimationViewer] Loaded ${t}/${o}`)}catch{}return e}processAtlas(t){var n,o,p;const e=Object.keys(t.animations||{}).sort();e.length===0&&t.frames&&(console.log("[AnimationViewer] No explicit animations array in atlas.json — using inferred states from frames."),e.push(...Object.keys(t.animations||{}).sort()));for(const x of e){const c=t.animations[x],i=c?c.frames.length:0;if(i===0){console.log(`[AnimationViewer] Skipping ${x} — no frames`);continue}const l=c&&c.fps?c.fps:((n=t.meta)==null?void 0:n.fps)||12,u=c&&typeof c.loop=="boolean"?c.loop:!0,A={name:x,character:this.currentCharacter,frames:i,fps:l,loop:u},b=new jt(t.image,t.frameW||256,t.frameH||256,{[x]:{src:"",frames:i,fps:l,loop:u,frameW:t.frameW||256,frameH:t.frameH||256,rects:c?c.frames:[],image:t.image,imageLoaded:!0,imageBroken:!1}}),$=b.animations[x];c&&($.rects=c.frames,$.frames=c.frames.length),$.image=t.image,$.imageLoaded=!0,$.imageBroken=!1,this.animations.push(A),this.animators.set(x,b),console.log(`[AnimationViewer] Registered animation '${x}' (${i} frames)`)}if(t.frames){const x=Object.keys(t.frames).filter(c=>!c.includes("_"));if(x.length>0){const c="__frames__",i=x.map(b=>{const $=t.frames[b].frame;return{x:$.x,y:$.y,w:$.w,h:$.h}}),l={name:c,character:this.currentCharacter,frames:i.length,fps:((o=t.meta)==null?void 0:o.fps)||12,loop:!0},u=new jt(t.image,t.frameW||256,t.frameH||256,{[c]:{src:"",frames:i.length,fps:((p=t.meta)==null?void 0:p.fps)||12,loop:!0,frameW:t.frameW||256,frameH:t.frameH||256,rects:i,image:t.image,imageLoaded:!0,imageBroken:!1}}),A=u.animations[c];A.rects=i,A.frames=i.length,A.image=t.image,A.imageLoaded=!0,A.imageBroken=!1,this.animations.push(l),this.animators.set(c,u),console.log(`[AnimationViewer] Added lone frames view with ${i.length} frames`)}}}updateAnimationList(){const t=document.getElementById("animation-list");t&&(t.innerHTML="",this.animations.forEach((e,n)=>{const o=document.createElement("div");o.style.cssText=`
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #333;
        color: #fff;
        font-size: 14px;
        transition: background-color 0.2s;
      `,n===this.currentAnimationIndex&&(o.style.backgroundColor="#0066cc"),o.innerHTML=`
        <div style="font-weight: bold;">${e.name}</div>
        <div style="font-size: 12px; color: #aaa;">
          ${e.frames} frames • ${e.fps} fps • ${e.loop?"Loop":"Once"}
        </div>
      `,o.onclick=()=>{this.currentAnimationIndex=n,this.updateDisplay(),this.updateAnimationList()},o.onmouseenter=()=>{n!==this.currentAnimationIndex&&(o.style.backgroundColor="#444")},o.onmouseleave=()=>{n!==this.currentAnimationIndex&&(o.style.backgroundColor="transparent")},t.appendChild(o)}))}updateDisplay(){if(this.animations.length===0)return;const t=this.animations[this.currentAnimationIndex],e=this.animators.get(t.name);if(!e)return;e.setState(t.name),this.frameSequencer.max=String(t.frames-1),this.frameSequencer.value=String(this.currentFrame),this.frameSequencerLabel.textContent=`Frame: ${this.currentFrame+1}/${t.frames}`;const n=document.getElementById("animation-info");n&&(n.innerHTML=`
        <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">
          ${t.name.toUpperCase()}
        </div>
        <div style="font-size: 14px; color: #aaa;">
          ${t.character} • ${t.frames} frames • ${t.fps} fps • ${t.loop?"Looping":"Single play"}
        </div>
      `),!this.animationId&&this.isPlaying&&this.startAnimationLoop(),this.updateAtlasPreview(t.name)}updateAtlasPreview(t){const e=this.animators.get(t);if(!e){this.atlasCtx.fillStyle="#000",this.atlasCtx.fillRect(0,0,this.atlasCanvas.width,this.atlasCanvas.height),this.timelineCtx.fillStyle="#111",this.timelineCtx.fillRect(0,0,this.timelineCanvas.width,this.timelineCanvas.height);return}const n=e.animations[t],o=n.image;if(!o)return;const p=o.naturalWidth,x=o.naturalHeight,c=this.atlasCanvas.width,i=this.atlasCanvas.height,l=Math.min(c/p,i/x),u=p*l,A=x*l,b=(c-u)/2,$=(i-A)/2;this.atlasCtx.clearRect(0,0,c,i),this.atlasCtx.drawImage(o,0,0,p,x,b,$,u,A);const _=n.rects||[];_.forEach((O,H)=>{const L=b+O.x*l,K=$+O.y*l,et=O.w*l,U=O.h*l;this.atlasCtx.strokeStyle=H===e.frame?"rgba(0,255,128,0.9)":"rgba(255,255,255,0.15)",this.atlasCtx.lineWidth=H===e.frame?2:1,this.atlasCtx.strokeRect(L,K,et,U),H===e.frame&&(this.atlasCtx.fillStyle="rgba(0,255,128,0.9)",this.atlasCtx.font="12px monospace",this.atlasCtx.fillText(String(H),L+2,K+12))});const P=this.timelineCtx,R=this.timelineCanvas.width,X=this.timelineCanvas.height;P.clearRect(0,0,R,X),P.fillStyle="#111",P.fillRect(0,0,R,X);const N=_.length||n.frames||1;n.fps;const V=R/N;for(let O=0;O<N;O++){const H=O*V;P.fillStyle=O===e.frame?"#00ff80":"#444",P.fillRect(H,0,Math.max(1,V-2),X-1),P.fillStyle="#ccc",P.font="10px monospace",P.fillText(String(O),H+2,X-6)}}startAnimationLoop(){const t=e=>{if(!this.isVisible||!this.isPlaying){this.animationId=null;return}const n=this.animations[this.currentAnimationIndex],o=this.animators.get(n.name);o?(this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,512,512),o.update(.016666666666666666),o.draw(this.ctx,0,0,512,512),this.currentFrame=o.frame,this.frameSequencer.value=String(this.currentFrame),this.frameSequencerLabel.textContent=`Frame: ${this.currentFrame+1}/${n.frames}`):(this.ctx.fillStyle="#ff0000",this.ctx.fillRect(0,0,512,512),this.ctx.fillStyle="#ffffff",this.ctx.font="16px Arial",this.ctx.fillText("No animator found",10,30)),this.animationId=requestAnimationFrame(t)};this.animationId=requestAnimationFrame(t)}previousAnimation(){this.animations.length!==0&&(this.currentAnimationIndex=(this.currentAnimationIndex-1+this.animations.length)%this.animations.length,this.updateDisplay(),this.updateAnimationList())}nextAnimation(){this.animations.length!==0&&(this.currentAnimationIndex=(this.currentAnimationIndex+1)%this.animations.length,this.updateDisplay(),this.updateAnimationList())}togglePlayPause(){const t=document.getElementById("play-pause-btn");t&&(this.isPlaying=!this.isPlaying,this.isPlaying?(this.startAnimationLoop(),t.textContent="⏸ Pause",t.style.background="#cc6600"):(this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),t.textContent="▶ Play",t.style.background="#0066cc"))}onFrameSequencerChange(){if(!this.isPlaying){const t=parseInt(this.frameSequencer.value);this.currentFrame=t;const e=this.animations[this.currentAnimationIndex],n=this.animators.get(e.name);n&&(n.frame=t,this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,512,512),n.draw(this.ctx,0,0,512,512),this.frameSequencerLabel.textContent=`Frame: ${t+1}/${e.frames}`,this.updateAtlasPreview(e.name))}}show(){this.isVisible=!0,this.modal.style.display="block",this.currentFrame=0,this.updateDisplay()}hide(){this.isVisible=!1,this.modal.style.display="none",this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}toggle(){this.isVisible?this.hide():this.show()}}let ae=null;function Kt(){return ae||(ae=new Le),ae}window.showAnimationViewer=()=>Kt().show();window.hideAnimationViewer=()=>Kt().hide();window.toggleAnimationViewer=()=>Kt().toggle();const xe={};function Ut(d,t){if(!d||typeof d!="string")throw new Error("behavior key must be a string");xe[d]=t}function We(d,t){const e=xe[d];if(!e)return null;const n=e(t||{});try{typeof n.init=="function"&&n.init(t)}catch{}return n}Ut("patrol",(d={})=>{const t=typeof d.minX=="number"?d.minX:0,e=typeof d.maxX=="number"?d.maxX:(d.canvasW||800)-100;let n=typeof d.startDir=="number"&&d.startDir>0?1:-1;return{update(o){var c,i;const p={};if(!o.p2)return p;const x=o.p2.x||0;return x<=t&&(n=1),x+(o.p2.w||0)>=e&&(n=-1),n===1?p[((c=d.keys)==null?void 0:c.right)||"right"]=!0:p[((i=d.keys)==null?void 0:i.left)||"left"]=!0,p}}});Ut("aggressive_melee",(d={})=>{const t=typeof d.attackRange=="number"?d.attackRange:90,e=typeof d.aggroRange=="number"?d.aggroRange:240;let n=0,o=-1;return{update(p){var A,b,$,_,P,R;const x={},c=p.p1,i=p.p2;if(!c||!i)return x;n=Math.max(0,n-p.dt);const l=(c.x||0)-(i.x||0),u=Math.abs(l);if(u<=e)l>t?x[((A=d.keys)==null?void 0:A.right)||"right"]=!0:l<-t&&(x[((b=d.keys)==null?void 0:b.left)||"left"]=!0),u<=t&&n<=0&&(($=d.keys)!=null&&$.attack1||!0)&&(x[((_=d.keys)==null?void 0:_.attack1)||"attack1"]=!0,n=typeof d.attackCooldown=="number"?d.attackCooldown:.9);else if(d.fallback==="patrol"&&d.patrolBounds){const[X,N]=d.patrolBounds;try{(i.x||0)<=X&&(o=1),(i.x||0)+(i.w||0)>=N&&(o=-1)}catch{}o===1?x[((P=d.keys)==null?void 0:P.right)||"right"]=!0:x[((R=d.keys)==null?void 0:R.left)||"left"]=!0}return x}}});Ut("ranged_kite",(d={})=>{const t=typeof d.preferredDistance=="number"?d.preferredDistance:220,e=typeof d.safeDistance=="number"?d.safeDistance:160;let n=0;return{update(o){var u,A,b,$,_,P,R,X;const p={},x=o.p1,c=o.p2;if(!x||!c)return p;n=Math.max(0,n-o.dt);const i=(x.x||0)-(c.x||0),l=Math.abs(i);l<e?i>0?p[((u=d.keys)==null?void 0:u.left)||"left"]=!0:p[((A=d.keys)==null?void 0:A.right)||"right"]=!0:l>t&&(i>0?p[((b=d.keys)==null?void 0:b.right)||"right"]=!0:p[(($=d.keys)==null?void 0:$.left)||"left"]=!0),l>=e&&l<=t&&n<=0&&((_=d.keys)!=null&&_.ranged1||!0)&&(p[((P=d.keys)==null?void 0:P.ranged1)||"ranged1"]=!0,n=typeof d.rangedCooldown=="number"?d.rangedCooldown:1.2);try{o.projectiles.some(V=>V.alive&&V.owner!==c&&Math.abs(V.x-c.x)<140)&&((R=d.keys)!=null&&R.parry||!0)&&(p[((X=d.keys)==null?void 0:X.parry)||"parry"]=!0)}catch{}return p}}});Ut("defensive_evade",(d={})=>{let t=0;return{update(e){var x,c,i,l;const n={},o=e.p1,p=e.p2;if(!o||!p)return n;t=Math.max(0,t-e.dt);try{e.projectiles.find(A=>A.alive&&A.owner!==p&&Math.abs(A.x-p.x)<160)&&((x=d.keys)!=null&&x.parry,n[((c=d.keys)==null?void 0:c.parry)||"parry"]=!0)}catch{}try{const u=e.canvasW||800,A=120;(p.x||0)<A?n[((i=d.keys)==null?void 0:i.right)||"right"]=!0:(p.x||0)+(p.w||0)>u-A&&(n[((l=d.keys)==null?void 0:l.left)||"left"]=!0)}catch{}return n}}});class ne{constructor(t){h(this,"lastJump",0);h(this,"attackCooldown",0);h(this,"parryCooldown",0);h(this,"keys");h(this,"isSolidAt");h(this,"canvasW",800);h(this,"canvasH",600);h(this,"patrolMinX",0);h(this,"patrolMaxX",800);h(this,"patrolDirection",-1);h(this,"edgeLookahead",48);h(this,"forcedFlipAfter",2);h(this,"noGroundTimer",0);h(this,"behavior",null);h(this,"aggroRange",300);h(this,"attackRange",90);h(this,"spawnX",null);h(this,"spawnClamp",300);h(this,"simplePatrol",!1);h(this,"patrolDistance",150);h(this,"patrolTargetX",null);h(this,"returningToSpawn",!1);h(this,"_lastPatrolLog",0);h(this,"isAggro",!1);h(this,"lastAggroLog",0);if(this.keys=t.keys,this.isSolidAt=t.isSolidAt,t.canvasW&&(this.canvasW=t.canvasW),t.canvasH&&(this.canvasH=t.canvasH),typeof t.patrolMinX=="number"&&(this.patrolMinX=t.patrolMinX),typeof t.patrolMaxX=="number"&&(this.patrolMaxX=t.patrolMaxX),typeof t.edgeLookahead=="number"&&(this.edgeLookahead=t.edgeLookahead),typeof t.forcedFlipAfter=="number"&&(this.forcedFlipAfter=t.forcedFlipAfter),typeof t.aggroRange=="number"&&(this.aggroRange=t.aggroRange),typeof t.attackRange=="number"&&(this.attackRange=t.attackRange),t.behaviorKey)try{this.behavior=We(t.behaviorKey,t.behaviorOpts||{})}catch{this.behavior=null}typeof t.spawnX=="number"&&(this.spawnX=t.spawnX),typeof t.spawnClamp=="number"&&(this.spawnClamp=t.spawnClamp),t.simplePatrol&&(this.simplePatrol=!0),typeof t.patrolDistance=="number"&&(this.patrolDistance=t.patrolDistance)}isPlayerInSight(t,e){try{if(!this.isSolidAt)return!0;const n=e.x||0,o=e.y||0,p=t.x||0,x=t.y||0,c=Math.abs(p-n),i=Math.max(1,Math.floor(c/20));for(let l=1;l<i;l++){const u=l/i,A=n+(p-n)*u,b=o+(x-o)*u;if(this.isSolidAt(Math.floor(A),Math.floor(b)))return!1}return!0}catch{return!0}}update(t,e,n,o,p){if(!n||!o)return;if(this.simplePatrol&&this.spawnX!==null){this.keys.left&&(e[this.keys.left]=!1),this.keys.right&&(e[this.keys.right]=!1),this.keys.up&&(e[this.keys.up]=!1),this.keys.attack1&&(e[this.keys.attack1]=!1),this.keys.parry&&(e[this.keys.parry]=!1);const _=n.x||0,P=this.spawnX,R=o.x||0,X=Math.abs(_-R),N=X<=this.aggroRange,V=this.isPlayerInSight(o,n);if(N&&V){this.isAggro||(this.isAggro=!0,console.log(`[NPC] 🔥 AGGRO! Player detected at ${X.toFixed(1)}px - switching to chase mode`)),_<R-5?this.keys.right&&(e[this.keys.right]=!0):_>R+5&&this.keys.left&&(e[this.keys.left]=!0),X<=this.attackRange&&this.attackCooldown<=0&&this.keys.attack1&&(e[this.keys.attack1]=!0,this.attackCooldown=1,console.log(`[NPC] ⚔️ ATTACK! Player at ${X.toFixed(1)}px`)),(!this.lastAggroLog||Date.now()-this.lastAggroLog>3e3)&&(console.log(`[NPC] 🔥 AGGRO: chasing player at ${X.toFixed(1)}px (attack range: ${this.attackRange}px)`),this.lastAggroLog=Date.now());return}else if(this.isAggro&&(this.isAggro=!1,console.log("[NPC] 😴 Lost player - returning to patrol mode")),this.patrolTargetX===null&&(this.patrolTargetX=P+this.patrolDistance,this.returningToSpawn=!1,console.log(`[NPC] 🚀 Starting patrol: spawn=${P.toFixed(1)}, target=${this.patrolTargetX.toFixed(1)}, distance=${this.patrolDistance}px`)),Math.abs(_-this.patrolTargetX)<10&&(this.returningToSpawn?(this.patrolTargetX=P+this.patrolDistance,this.returningToSpawn=!1,console.log(`[NPC] 🔄 Back at spawn! Starting new patrol cycle: target=${this.patrolTargetX.toFixed(1)}`)):(this.patrolTargetX=P,this.returningToSpawn=!0,console.log(`[NPC] 🎯 Reached patrol point! Returning to spawn: target=${this.patrolTargetX.toFixed(1)}`))),this.patrolTargetX!==null&&(_<this.patrolTargetX-5?this.keys.right&&(e[this.keys.right]=!0):_>this.patrolTargetX+5&&this.keys.left&&(e[this.keys.left]=!0)),!this._lastPatrolLog||Date.now()-this._lastPatrolLog>2e3){const H=this.returningToSpawn?"← returning to spawn":"→ going to patrol point",L=Math.abs(_-this.patrolTargetX);console.log(`[NPC] 📍 Status: pos=${_.toFixed(1)}, target=${this.patrolTargetX.toFixed(1)}, dist=${L.toFixed(1)}px ${H}`),this._lastPatrolLog=Date.now()}return}const x=_=>{try{if(this.spawnX===null)return!1;const P=this.spawnX;return _===1?(n.x||0)>=P+this.spawnClamp:(n.x||0)<=P-this.spawnClamp}catch{return!1}};if(this.behavior&&typeof this.behavior.update=="function")try{const _={dt:t,p1:o,p2:n,projectiles:p,isSolidAt:this.isSolidAt,canvasW:this.canvasW,canvasH:this.canvasH},P=this.behavior.update(_,{})||{},R=this.keys.left||"left",X=this.keys.right||"right",N={};for(const V of Object.keys(P))N[V]=!!P[V];try{const V=Math.floor(n.y+n.h+2);if(N[R]){if(x(-1))N[R]=!1;else if(this.isSolidAt&&n.onGround){const H=Math.floor((n.x||0)+(n.w||0)*.5-this.edgeLookahead);this.isSolidAt(H,V)===!1&&(N[R]=!1)}}if(N[X]){if(x(1))N[X]=!1;else if(this.isSolidAt&&n.onGround){const H=Math.floor((n.x||0)+(n.w||0)*.5+this.edgeLookahead);this.isSolidAt(H,V)===!1&&(N[X]=!1)}}}catch{}for(const V of Object.keys(N||{}))e[V]=!!N[V]}catch{}this.lastJump+=t,this.attackCooldown>0&&(this.attackCooldown-=t),this.parryCooldown>0&&(this.parryCooldown-=t);const c=o.x-n.x,i=Math.abs(c);this.keys.left&&(e[this.keys.left]=!1),this.keys.right&&(e[this.keys.right]=!1),this.keys.up&&(e[this.keys.up]=!1),this.keys.attack1&&(e[this.keys.attack1]=!1),this.keys.parry&&(e[this.keys.parry]=!1);const l=(n.damagePercent||0)>=50,u=typeof n.stocks=="number"?n.stocks<=1:!1;try{const _=n.canvasW||n.canvasWidth||this.canvasW||800,P=140;n.x<P&&this.keys.right?e[this.keys.right]=!0:n.x+n.w>_-P&&this.keys.left&&(e[this.keys.left]=!0)}catch{}const A=p.some(_=>_.alive&&_.owner!==n&&Math.abs(_.x-n.x)<140),b=o.attacking1||o.attacking2;if((typeof n.parryCooldown=="number"?n.parryCooldown:this.parryCooldown)<=0){if(A&&this.keys.parry){e[this.keys.parry]=!0,this.parryCooldown=.1;try{n&&(n.parrying=!0,n.parryTimer=(n.parryDurationDefault||.25)*.6,n.parryConsumed=!1,n.anim&&n.anim.setState("parry"))}catch{}}else if(b&&i<180&&this.keys.parry){e[this.keys.parry]=!0,this.parryCooldown=.1;try{n&&(n.parrying=!0,n.parryTimer=(n.parryDurationDefault||.25)*.6,n.parryConsumed=!1,n.anim&&n.anim.setState("parry"))}catch{}}}try{if(this.isSolidAt&&(this.keys.left||this.keys.right)){const _=Math.floor(n.y+n.h+2),P=(N,V=40)=>{const O=Math.floor(n.x+n.w*.5+N*V);return this.isSolidAt(O,_)},R=P(1,48),X=P(-1,48);n.onGround&&(this.keys.right&&!R&&this.keys.left?e[this.keys.left]=!0:this.keys.left&&!X&&this.keys.right&&(e[this.keys.right]=!0))}}catch{}if(!l&&!u)i>250?this.keys.right&&c>0?e[this.keys.right]=!0:this.keys.left&&c<0&&(e[this.keys.left]=!0):this.attackCooldown<=0&&this.keys.attack1&&(e[this.keys.attack1]=!0,this.attackCooldown=.8);else try{const P=((n.canvasW||n.canvasWidth||800)-n.w)*.5;n.x<P-10&&this.keys.right?e[this.keys.right]=!0:n.x>P+10&&this.keys.left&&(e[this.keys.left]=!0)}catch{}}}class ye{constructor(t){h(this,"inner");const e={keys:t.keys||{},isSolidAt:t.isSolidAt,canvasW:t.canvasW,canvasH:t.canvasH,patrolMinX:t.patrolMinX,patrolMaxX:t.patrolMaxX,edgeLookahead:t.edgeLookahead,forcedFlipAfter:t.forcedFlipAfter,spawnX:t.spawnX,spawnClamp:t.spawnClamp,simplePatrol:t.simplePatrol,patrolDistance:t.patrolDistance};this.inner=new ne(e)}update(t,e,n,o,p){try{this.inner.update(t,e,n,o,p)}catch{}}}function Ee(d){const t=d.getContext("2d");let e=window.innerWidth,n=window.innerHeight;const o=window.devicePixelRatio||1;function p(){e=window.innerWidth,n=window.innerHeight,d.style.width=e+"px",d.style.height=n+"px",d.width=Math.max(1,Math.floor(e*o)),d.height=Math.max(1,Math.floor(n*o)),t.setTransform(o,0,0,o,0,0)}p(),window.addEventListener("resize",p),console.log(`[qte] createGame initialized ${JSON.stringify({WIDTH:e,HEIGHT:n})}`);let x="character_selection",c={p1:null,p2:null},i=1,l=0;const u=je(d),A={};let b=null,$=null,_=!1,P=0;const R=200,X=document.createElement("button");X.textContent="🎬 View Animations",X.style.cssText=`
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 1000;
    background: #0066cc;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 16px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  `,X.onclick=()=>Kt().show(),document.body.appendChild(X);const N=document.createElement("button");N.textContent="🎯 Singleplayer (Laurin)",N.style.cssText=`
    position: fixed;
    top: 50px;
    left: 10px;
    z-index: 1000;
    background: #10b981;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  `,N.onclick=()=>{try{console.log("[DEBUG] Singleplayer button clicked! Setting up Laurin vs Cyboard..."),c.p1="laurin",c.p2="cyboard",H=!0,console.log(`[DEBUG] useAIForP2 set to: ${H}`),x="game",le()}catch(r){console.error("[DEBUG] Error in singleplayer setup:",r)}},document.body.appendChild(N);const V=document.createElement("button");V.textContent="🧪 Test Section 2 (Granny)",V.style.cssText=`
    position: fixed;
    top: 90px;
    left: 10px;
    z-index: 1000;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  `,V.onclick=()=>{x==="game"&&!wt?(console.log("[qte] Test: Triggering transition to section 2 for Granny NPC test"),re(2,"right")):console.log("[qte] Test: Cannot trigger section transition - game not running or already transitioning")},document.body.appendChild(V);let O=null,H=!1,L=null;function K(){return!!L||!!O||!!H}const et=document.createElement("div");et.style.cssText="position: fixed; top: 50px; right: 10px; z-index:1000; color: white;";const U=document.createElement("label");U.style.cssText="font-family: Arial; font-size: 14px; display: flex; align-items: center; gap:8px;";const it=document.createElement("input");it.type="checkbox",it.checked=!1,it.onchange=()=>{H=!!it.checked},U.appendChild(it);const ct=document.createElement("span");ct.textContent="Play vs AI (P2)",U.appendChild(ct),et.appendChild(U),document.body.appendChild(et);let f=null,s=null,T=null,mt=null,Ct={bounds:{w:e,h:n},platforms:[],fallThreshold:n+300};function Ht(){Ct.bounds.w=e,Ct.bounds.h=n,Ct.fallThreshold=n+300,T&&(T.x>e||T.y>n)&&(console.log(`[qte] 🔄 Canvas resized - repositioning Granny from (${T.x}, ${T.y}) to fit new canvas ${e}x${n}`),T.x=Math.min(T.x,e-100),T.y=Math.min(T.y,n-200),console.log(`[qte] ✅ Granny repositioned to (${T.x}, ${T.y})`))}function Tt(r,m){if(!G||!G.resolution)return{x:r,y:m};const[w,y]=G.resolution,F=Math.floor(r/w*e),J=Math.floor(m/y*n);return{x:F,y:J}}function Ft(){try{if(gt&&tt&&tt.width>0&&st&&st.naturalWidth>0){const r=st.naturalWidth,m=st.naturalHeight,w=e/n,y=r/m;let F=0,J=0,D=r,a=m;y>w?(D=Math.round(m*w),F=Math.round((r-D)*.5)):(a=Math.round(r/w),J=Math.round((m-a)*.5));const g=Math.floor(F+.5*D),k=Math.max(0,Math.floor(n*.3));for(let I=k;I<n;I++){const q=Math.floor(J+I/n*a);if(q<0||q>=tt.height||g<0||g>=tt.width)continue;if(gt.getImageData(g,q,1,1).data[3]>128)return I}}}catch{}return n-220}function Lt(r,m){try{if(!(gt&&tt&&tt.width>0&&st&&st.naturalWidth>0))return console.warn("[qte][heatmap] isSolidAtCanvasPoint: heatmap not ready",{hasCtx:!!gt,hasCanvas:!!tt,canvasW:tt==null?void 0:tt.width,hasImg:!!st,imgW:st==null?void 0:st.naturalWidth}),!1;const w=Math.max(0,Math.min(e-1,Math.floor(r))),y=Math.max(0,Math.min(n-1,Math.floor(m))),F=st.naturalWidth,J=st.naturalHeight,D=e/n,a=F/J;let g=0,k=0,I=F,q=J;a>D?(I=Math.round(J*D),g=Math.round((F-I)*.5)):(q=Math.round(F/D),k=Math.round((J-q)*.5));const j=Math.floor(g+w/e*I),v=Math.floor(k+y/n*q),M=Math.max(0,Math.min(tt.width-1,j)),B=Math.max(0,Math.min(tt.height-1,v));return gt.getImageData(M,B,1,1).data[3]>128}catch{return!1}}Ht();const ht=[],ft=[];let Wt=!1,$t=null,G=null,st=new Image,_t=new Image,xt=new Image,E=1,wt=!1,qt=null,kt=0,St=0,Jt=null,Et=null,Xt=null,zt=!1,Qt=null;const Mt={};function Pt(r){return`/levels/sidescroller/ninja_stage/sections/section_${String(r).padStart(2,"0")}`}async function ie(r){try{console.log(`[qte] Attempting to load section_${String(r).padStart(2,"0")} data...`);const m=Pt(r),w=await fetch(`${m}/section.json`);if(!w.ok)throw new Error(`HTTP ${w.status}: ${w.statusText}`);const y=await w.json();return console.log("[qte] ✅ Loaded section data:",y),Mt[r]=y,y}catch(m){console.error("[qte] ❌ Failed to load section data:",m);const w=Pt(r);console.log("[qte] Using fallback paths for section:",w);const y={background:`${w}/stage.png`,heatmap:`${w}/heatmap.png`,spawn_points:null};return Mt[r]=y,y}}function se(r,m){G=r||null;try{r&&r.background&&(st.src=r.background),r&&r.heatmap&&(xt.src=r.heatmap);let w=null;r&&r.foreground?w=String(r.foreground):r&&r.background?w=String(r.background).replace(/\/stage\.(png|jpg|jpeg|webp)$/i,"/stage_foreground.png"):w=`${Pt(typeof m=="number"?m:E)}/stage_foreground.png`,w&&(_t.src=w)}catch{}try{if(G&&s&&E===1){const w=G.spawn_points&&G.spawn_points.find(y=>y.name==="npc_spawn_1");if(w){const y=Tt(w.x,w.y);y.y-=250,s.x=y.x,s.y=y.y,s.vx=0,s.vy=0,s.facing=-1,console.log("[qte] ✅ Repositioned P2 (NPC1) to section 1 spawn npc_spawn_1:",w,"->",y)}}else E>1&&s&&(console.log(`[qte] Removing P2 (NPC1) - current section ${E} > 1`),s=null,O=null,L=null)}catch{}try{console.log(`[qte] 🔍 Granny spawn check - currentSectionIdx: ${E}, sectionData:`,G==null?void 0:G.section_key),console.log("[qte] 🔍 Granny already exists:",!!T),E>=2?(console.log(`[qte] ✅ Section check passed (${E} >= 2), calling createGrannyNpc()`),ve()):(console.log(`[qte] ❌ Section check failed (${E} < 2)`),T&&(console.log(`[qte] Removing Granny NPC - current section ${E} < 2`),T=null,mt=null))}catch(w){console.error("[qte] Failed to create/update Granny NPC:",w)}}async function we(r){console.log(`[qte] 📥 preloadAndApplySection called for section ${r}`);const m=await ie(r);console.log(`[qte] 🔄 Updating currentSectionIdx: ${E} -> ${r}`),E=r,console.log(`[qte] 📝 Applying section assets for section ${r}`),se(m,r),Mt[r]=m,console.log(`[qte] ✅ preloadAndApplySection completed for section ${r}`)}async function ke(r){Et=await ie(r)}function re(r,m="right"){if(console.log(`[qte] 🚀 startSectionTransition called: ${E} -> ${r} (${m})`),wt){console.log("[qte] ❌ Already transitioning, ignoring request");return}console.log(`[qte] 🔄 Starting transition - currentSectionIdx: ${E}, targetSectionIdx: ${r}`),wt=!0,qt="fade_out",kt=0,St=r,Qt=m,Et=null;try{Jt=ke(r)}catch{Jt=null}try{f&&(f._frozen=!0)}catch{}try{s&&(s._frozen=!0)}catch{}try{T&&(T._frozen=!0)}catch{}zt=!1,console.log(`[qte] 🔄 Transition initialized - pendingSectionPromise: ${!!Jt}`)}function Zt(r,m){return new Promise(w=>{try{const y=()=>w();if(r.complete&&r.naturalWidth>0&&r.src===m){w();return}const F=()=>{r.removeEventListener("load",F),y()};r.addEventListener("load",F),r.src=m,r.complete&&r.naturalWidth>0&&(r.removeEventListener("load",F),w())}catch{w()}})}function be(r){const m=r&&r.background?String(r.background):Pt(St)+"/stage.png",w=r&&r.heatmap?String(r.heatmap):Pt(St)+"/heatmap.png",y=Pt(St)+"/stage_foreground.png";return Promise.all([Zt(st,m),Zt(xt,w),Zt(_t,y)]).then(()=>{G=r||G,St&&(Mt[St]=G)})}we(1);async function ve(){try{if(console.log(`[qte] 🚀 createGrannyNpc() called - currentSectionIdx: ${E}`),console.log("[qte] 🚀 sectionData:",G==null?void 0:G.section_key),console.log("[qte] 🚀 grannyNpc exists:",!!T),E<2){console.log(`[qte] ❌ Granny not spawned - current section ${E} < 2`);return}if(T){console.log("[qte] ❌ Granny already exists, skipping creation");return}if(E<2){console.log(`[qte] ❌ Granny creation blocked - current section ${E} < 2`);return}if(E>=2)console.log(`[qte] ✅ currentSectionIdx check passed (${E} >= 2), ignoring stale sectionData: ${G==null?void 0:G.section_key}`);else if(G&&G.section_key&&!G.section_key.includes("section_02")){console.log(`[qte] ❌ Granny creation blocked - not in section 2, current: ${G.section_key}`);return}if(E===1||G&&G.section_key&&G.section_key.includes("section_01")){console.log(`[qte] ❌ Granny creation blocked - in section 1, currentSectionIdx: ${E}, sectionData: ${G==null?void 0:G.section_key}`);return}console.log("[qte] ✅ All checks passed, proceeding with Granny creation..."),console.log(`[qte] Creating Granny NPC for section ${E}...`),console.log("[qte] Current section data:",(G==null?void 0:G.section_key)||"none");const r=Yt("granny");if(!r){console.error("[qte] Granny character config not found");return}const m=await At(r.atlasPath),w=Vt(r.folder,r.overrides);let y=Math.min(1030,e-100),F=Math.min(n*.25,n-200);if(console.log(`[qte] Canvas bounds check - WIDTH: ${e}, HEIGHT: ${n}`),console.log(`[qte] Adjusted spawn position: (${y}, ${F})`),G&&G.spawn_points){const D=G.spawn_points.find(a=>a.name==="granny_spawn"||a.name==="npc_spawn_2");if(D){const a=Tt(D.x,D.y);y=a.x,F=a.y-250,console.log("[qte] Using section spawn point for Granny:",D,"-> canvas:",a)}else console.log(`[qte] Using default spawn position for Granny in section 2: (${y}, ${F})`)}T=new ee({x:y,y:F,color:r.color,keys:z,name:"Granny",characterId:r.name,spriteConfig:w,ctx:t,canvasWidth:e,canvasHeight:n,muzzleOffset:{x:-36,y:-48}}),T.facing=-1,T.hp=3,T.maxHp=3,T.allowGroundCollision=!0,T.onGround=!0,T.vy=0,T.vx=0;try{m&&m.frameH&&(T.h=m.frameH),m&&m.frameW&&(T.w=m.frameW)}catch{}if(T.x=y,T.y=F,console.log(`[qte] Granny positioned at spawn: (${y}, ${F})`),console.log(`[qte] Canvas dimensions: ${e}x${n}`),console.log(`[qte] Granny spawn within canvas bounds: X=${y>=0&&y<=e}, Y=${F>=0&&F<=n}`),T&&T.anim&&m){const D=Object.keys(T.anim.animations);for(const a of D){const g=m.animations[a],k=T.anim.animations[a];k&&(k.image=m.image,k.src=m.image.src,k.imageLoaded=!0,k.imageBroken=!1,g&&(k.rects=g.frames,k.frameW=m.frameW,k.frameH=m.frameH,k.frames=g.frames.length,k.fps=k.fps||(typeof g.fps=="number"?g.fps:m&&m.meta&&m.meta.fps||12),k.loop=typeof g.loop=="boolean"?g.loop:k.loop??!0))}}const J=(D,a)=>Lt(D,a);mt=new ye({keys:{left:z.left,right:z.right,up:z.up,attack1:z.attack1},isSolidAt:J,canvasW:e,canvasH:n,spawnX:y,simplePatrol:!0,patrolDistance:100}),mt&&typeof mt.spawnX=="number"&&(mt.spawnX=y,console.log(`[qte] Updated Granny AI controller spawn position to: ${y}`)),console.log(`[qte] ✅ Granny NPC created successfully in section ${E} at (${y}, ${F})`),console.log("[qte] 🎯 Granny will patrol around spawn point with 100px radius")}catch(r){console.error("[qte] Failed to create Granny NPC:",r)}}const tt=document.createElement("canvas"),gt=tt.getContext("2d");let oe=!1;xt.onload=()=>{try{tt.width=xt.naturalWidth||xt.width,tt.height=xt.naturalHeight||xt.height,gt&&gt.drawImage(xt,0,0),oe=!0,console.info("[qte][heatmap] Heatmap loaded successfully",{src:xt.src,size:{w:tt.width,h:tt.height},section:E});try{Se("#ff00ff",30)}catch{}}catch(r){console.error("[qte][heatmap] Failed to initialize heatmap canvas",r)}};const Nt={};function Se(r,m=30,w=2){try{if(!gt||!tt||tt.width===0)return null;const y=typeof E=="number"?`section_${String(E).padStart(2,"0")}`:"default";if(Nt[y])return Nt[y];const F=tt.width,J=tt.height,D=gt.getImageData(0,0,F,J).data,a=Ae(r);if(!a)return null;let g=F,k=0,I=!1;for(let M=0;M<J;M+=w)for(let B=0;B<F;B+=w){const Y=(M*F+B)*4,Z=D[Y],ot=D[Y+1],at=D[Y+2];if(D[Y+3]===0)continue;Ce(Z,ot,at,a.r,a.g,a.b)<=m&&(I=!0,B<g&&(g=B),B>k&&(k=B))}if(!I)return Nt[y]=null,null;const q=Math.floor(g/F*e),j=Math.floor(k/F*e),v={minX:q,maxX:j};return Nt[y]=v,console.info("[qte] Detected patrol region on heatmap",v,"section=",y),v}catch{return null}}function Ae(r){const m=/^#?([a-fA-F0-9]{6})$/.exec(r);if(!m)return null;const w=m[1];return{r:parseInt(w.slice(0,2),16),g:parseInt(w.slice(2,4),16),b:parseInt(w.slice(4,6),16)}}function Ce(r,m,w,y,F,J){const D=r-y,a=m-F,g=w-J;return Math.sqrt(D*D+a*a+g*g)}let ut=null,yt=null;async function Ot(r){const m=Yt(r);if(m)try{console.log(`[qte] Loading character ${r} for selection`);const w=await At(m.atlasPath);$=w;const y=Vt(m.folder,m.overrides),F=new Image;if(F.src=y.animations.idle.src||"",b=new jt(F,y.frameW,y.frameH,y.animations),w&&w.image){const J=Object.keys(b.animations);for(const D of J){const a=w.animations[D],g=b.animations[D];g.image=w.image,g.src=w.image.src,g.imageLoaded=!0,g.imageBroken=!1,a?(g.rects=a.frames,g.frameW=w.frameW,g.frameH=w.frameH,g.frames=a.frames.length,D==="hurt"&&(g.loop=!1),console.debug(`[qte] Character Selection: Patched ${D} with ${a.frames.length} atlas frames`)):console.debug(`[qte] Character Selection: No atlas frames for ${D}, using atlas image fallback`)}}b.setState("spawn"),_=!1,console.log(`[qte] Character ${r} loaded for selection`)}catch(w){console.warn(`[qte] Failed to load character ${r}: ${String(w)}`)}}function _e(r){var m;if(t.fillStyle="#071428",t.fillRect(0,0,e,n),t.fillStyle="#fff",t.font="bold 48px Arial",t.textAlign="center",t.fillText("CHARACTER SELECTION",e/2,80),t.font="bold 32px Arial",t.fillStyle=i===1?"#4aa3ff":"#ff7a7a",t.fillText(`Player ${i} - Choose Your Fighter`,e/2,140),b){const w=e/2-128,y=n/2-128;b.update(r),b.state==="spawn"&&b.frame>=(((m=b.animations.spawn)==null?void 0:m.frames)||6)-1&&(_||(_=!0,b.setState("idle"))),b.draw(t,w,y,256,256)}t.textAlign="left"}function Pe(r){const m=performance.now();if(m-P<R)return;const w=de(Q,z),F=(navigator.getGamepads&&navigator.getGamepads()||[])[0]||null,J={};function D(g){return!!u[g]}if([Q.left,Q.right,Q.attack1].forEach(g=>{g&&(J[g]=!!w[g]||D(g))}),J[Q.left]&&(P=m,l=(l-1+vt.length)%vt.length,Ot(vt[l].name)),J[Q.right]&&(P=m,l=(l+1)%vt.length,Ot(vt[l].name)),!!(J[Q.attack1]||F&&F.buttons&&F.buttons[0]&&F.buttons[0].pressed)){P=m;const g=vt[l].name;if(i===1)c.p1=g,i=2,console.log(`[qte] Player 1 selected: ${g}`);else{c.p2=g,console.log(`[qte] Player 2 selected: ${g}`),console.log(`[qte] Starting game with P1: ${c.p1}, P2: ${c.p2}`),x="game",le();return}Ot(vt[l].name)}}async function le(){var r,m,w,y,F,J,D;if(!c.p1||!c.p2){console.error("[qte] Cannot initialize game - missing character selections");return}try{const a=Yt(c.p1),g=Yt(c.p2);if(!a||!g){console.error("[qte] Invalid character configurations");return}const k=[At(a.atlasPath),At(g.atlasPath)],I=[];if(a.extraAtlas&&Array.isArray(a.extraAtlas))for(const S of a.extraAtlas)I.push(At(S.replace(/\.json$/,"")));if(g.extraAtlas&&Array.isArray(g.extraAtlas))for(const S of g.extraAtlas)I.push(At(S.replace(/\.json$/,"")));const q=await Promise.all([...k,...I]),j=q[0],v=q[1],M=q.slice(2),B=Vt(a.folder,a.overrides),Y=Vt(g.folder,g.overrides),Z=(S,C=800)=>new Promise(W=>{try{const rt=new Image;let lt=!1;const dt=()=>{lt||(lt=!0,W())};if(rt.onload=dt,rt.onerror=dt,rt.src=S,rt.complete&&rt.naturalWidth>0){dt();return}setTimeout(dt,C)}catch{W()}});await Promise.all([Z(Rt),Z(Dt)]);let ot={x:100,y:400},at={x:e-100-256,y:400};if(console.log("[qte] 🔍 Checking section data for spawn points..."),console.log("[qte] sectionData exists:",!!G),console.log("[qte] sectionData.spawn_points exists:",!!(G&&G.spawn_points)),G&&G.spawn_points){const S=G.spawn_points.find(W=>W.name==="player_start"),C=G.spawn_points.find(W=>W.name==="npc_spawn_1");console.log("[qte] Found playerStart:",S),console.log("[qte] Found npcSpawn:",C),S&&(ot=Tt(S.x,S.y),ot.y-=250,console.log("[qte] ✅ P1 spawn from section:",S,"-> canvas:",ot)),C&&E===1?(at=Tt(C.x,C.y),at.y-=250,console.log("[qte] ✅ P2 (NPC1) spawn from section 1:",C,"-> canvas:",at)):E>1&&(console.log("[qte] P2 (NPC1) not created - current section",E,"> 1"),at=null)}else console.warn("[qte] ⚠️ No section data available, using fallback spawn positions"),console.log("[qte] Fallback P1 spawn:",ot),E===1?console.log("[qte] Fallback P2 spawn:",at):(console.log("[qte] P2 (NPC1) not created - current section",E,"> 1"),at=null);if(f=new ee({x:ot.x,y:ot.y,color:a.color,keys:Q,name:"P1",characterId:a.name,spriteConfig:B,ctx:t,canvasWidth:e,canvasHeight:n,muzzleOffset:{x:36,y:-48}}),at&&E===1?(s=new ee({x:at.x,y:at.y,color:g.color,keys:z,name:"P2",characterId:g.name,spriteConfig:Y,ctx:t,canvasWidth:e,canvasHeight:n,muzzleOffset:{x:-36,y:-48}}),s.facing=-1,console.log("[qte] ✅ P2 (NPC1) created in section 1")):(console.log("[qte] P2 (NPC1) not created - current section",E,"> 1"),s=null),f&&(f.allowGroundCollision=!1),s&&(s.allowGroundCollision=!1),console.log(`[DEBUG] useAIForP2 = ${H}, creating AI for P2...`),H&&E===1)try{console.log("[DEBUG] Step 1: Using imported SimpleAI..."),console.log("[DEBUG] Step 2: SimpleAI available:",!!ne);const S=(bt,$e)=>Lt(bt,$e);console.log("[DEBUG] Step 3: isSolid function created");const C=at&&typeof at.x=="number"?at.x:e-220;console.log("[DEBUG] Step 4: spawnXForAI calculated:",C);const W=Math.max(0,Math.floor(C-300)),rt=Math.min(e,Math.floor(C+300)),lt=200,dt=Math.max(0,Math.floor(C-lt)),nt=Math.min(e,Math.floor(C+lt));console.info("[qte][ai] Setting up P2 patrol around spawn point:",{spawnX:C,patrolRadius:lt,bounds:{minX:dt,maxX:nt}}),console.log("[DEBUG] Step 5: About to create SimpleAI instance..."),O=new ne({keys:{left:z.left,right:z.right,up:z.up,attack1:z.attack1,parry:z.parry},isSolidAt:S,canvasW:e,canvasH:n,spawnX:C,simplePatrol:!0,patrolDistance:150}),console.log("[DEBUG] Step 6: SimpleAI constructor completed successfully"),console.log(`[NPC] 🤖 SimpleAI initialized with simple patrol: spawn=${C.toFixed(1)}, distance=150px`)}catch(S){console.error("[DEBUG] Error creating SimpleAI:",S),O=null}if(!H&&!s&&E===1)try{const S=(dt,nt)=>Lt(dt,nt),C=typeof at=="object"&&at&&typeof at.x=="number"?at.x:e-220,W=150,rt=Math.max(0,Math.floor(C-W)),lt=Math.min(e,Math.floor(C+W));L=new ye({keys:{left:z.left,right:z.right,up:z.up,attack1:z.attack1},isSolidAt:S,canvasW:e,canvasH:n,patrolMinX:rt,patrolMaxX:lt,aggroRange:240,attackRange:100})}catch{L=null}const It=(S,C)=>{var rt;if(!C||!C.image)return;S.defaultImage=C.image;const W=Object.keys(S.animations);for(const lt of W){const dt=C.animations[lt];S.animations[lt]||(S.animations[lt]={});const nt=S.animations[lt];if(nt.image=C.image,nt.src=C.image.src,nt.imageLoaded=!0,nt.imageBroken=!1,dt){const bt=dt;nt.rects=bt.frames,nt.frameW=C.frameW,nt.frameH=C.frameH,nt.frames=bt.frames.length,nt.fps=nt.fps||(typeof bt.fps=="number"?bt.fps:((rt=C.meta)==null?void 0:rt.fps)||12),nt.loop=typeof bt.loop=="boolean"?bt.loop:nt.loop??!0,lt==="hurt"&&(nt.loop=!1)}else nt.frameW=nt.frameW||C.frameW,nt.frameH=nt.frameH||C.frameH}};It(f.anim,j),s&&It(s.anim,v);try{a&&(a.name==="laurin"||a.name==="Laurin")&&f&&f.anim&&f.anim.animations.jump&&(f.anim.animations.jump.loop=!1),g&&(g.name==="laurin"||g.name==="Laurin")&&s&&s.anim&&s.anim.animations.jump&&(s.anim.animations.jump.loop=!1)}catch{}try{if(a&&a.name&&f&&f.anim&&(a.name==="laurin"||a.name==="Laurin")){const S=f.anim.animations.idle;if(S){const C=S.fps||((r=j==null?void 0:j.meta)==null?void 0:r.fps)||12;S.fps=Math.max(1,Math.floor(C/2))}}if(g&&g.name&&s&&s.anim&&(g.name==="laurin"||g.name==="Laurin")){const S=s.anim.animations.idle;if(S){const C=S.fps||((m=v==null?void 0:v.meta)==null?void 0:m.fps)||12;S.fps=Math.max(1,Math.floor(C/2))}}}catch{}try{if(M&&M.length>0){for(const S of M)if(!(!S||!S.image)){if(f&&f.anim)for(const C of Object.keys(S.animations)){f.anim.animations[C]=f.anim.animations[C]||{};const W=f.anim.animations[C];W.image=S.image,W.src=S.image.src,W.imageLoaded=!0,W.imageBroken=!1,W.rects=S.animations[C].frames,W.frameW=S.frameW,W.frameH=S.frameH,W.frames=S.animations[C].frames.length,W.fps=W.fps||(S.animations[C]&&typeof S.animations[C].fps=="number"?S.animations[C].fps:((w=S.meta)==null?void 0:w.fps)||((y=j==null?void 0:j.meta)==null?void 0:y.fps)||12),W.loop=S.animations[C]&&typeof S.animations[C].loop=="boolean"?S.animations[C].loop:W.loop??!0,C==="hurt"&&(W.loop=!1),C==="projectile3"&&console.log("[qte] PATCHED PROJECTILE3 INTO P1:",{state:C,frames:W.frames,rects:(F=W.rects)==null?void 0:F.length,image:!!W.image,fps:W.fps,loop:W.loop})}if(s&&s.anim)for(const C of Object.keys(S.animations)){s.anim.animations[C]=s.anim.animations[C]||{};const W=s.anim.animations[C];W.image=S.image,W.src=S.image.src,W.imageLoaded=!0,W.imageBroken=!1,W.rects=S.animations[C].frames,W.frameW=S.frameW,W.frameH=S.frameH,W.frames=S.animations[C].frames.length,W.fps=W.fps||(S.animations[C]&&typeof S.animations[C].fps=="number"?S.animations[C].fps:((J=S.meta)==null?void 0:J.fps)||((D=v==null?void 0:v.meta)==null?void 0:D.fps)||12),W.loop=S.animations[C]&&typeof S.animations[C].loop=="boolean"?S.animations[C].loop:W.loop??!0,C==="hurt"&&(W.loop=!1)}}}}catch(S){console.warn("[qte] failed to patch extra atlases",S)}ut=j,yt=v}catch(a){console.error("[qte] Failed to initialize game:",a)}}Ot(vt[0].name);let ce=performance.now();function te(r){var J,D;const m=Math.min(.05,(r-ce)/1e3);if(ce=r,x==="character_selection"){Pe(),_e(m),requestAnimationFrame(te);return}const w=de(Q,z),y={};function F(a){return!!u[a]}[Q.left,Q.right,Q.up,Q.down,Q.attack1,Q.attack2,Q.parry,Q.ranged1,Q.ranged2,Q.transform,Q.dodge].forEach(a=>{a&&(y[a]=!!w[a]||F(a))}),[z.left,z.right,z.up,z.down,z.attack1,z.attack2,z.parry,z.ranged1,z.ranged2,z.transform,z.dodge].forEach(a=>{a&&(y[a]=!!w[a]||F(a))});try{const a=!!y[Q.parry],g=!!y[z.parry];y[Q.parry]=a&&!A[Q.parry],y[z.parry]=g&&!A[z.parry],A[Q.parry]=a,A[z.parry]=g}catch{}if(!wt&&O&&s)try{try{const a=s._aiPauseTimer;typeof a=="number"&&a>0?s._aiPauseTimer=Math.max(0,a-m):O.update(m,y,s,f,ht)}catch{O.update(m,y,s,f,ht)}}catch{}if(!wt&&L&&s)try{const a=s._aiPauseTimer;typeof a=="number"&&a>0?s._aiPauseTimer=Math.max(0,a-m):L.update(m,y,s,f,ht)}catch{}if(!wt&&mt&&T)try{const a=T._aiPauseTimer;typeof a=="number"&&a>0?T._aiPauseTimer=Math.max(0,a-m):mt.update(m,y,T,f,ht)}catch{}if(f&&s&&((y[Q.parry]&&!f.parrying||y[z.parry]&&!s.parrying)&&console.log("[qte] PARRY INPUT DETECTED:",{P1_parry:y[Q.parry],P2_parry:y[z.parry],P1_key:Q.parry,P2_key:z.parry}),(y[Q.attack1]&&!f.attacking1||y[z.attack1]&&!s.attacking1)&&console.log("[qte] ATTACK1 INPUT DETECTED:",{P1_attack1:y[Q.attack1],P2_attack1:y[z.attack1]}),(y[Q.attack2]&&!f.attacking2||y[z.attack2]&&!s.attacking2)&&console.log("[qte] ATTACK2 INPUT DETECTED:",{P1_attack2:y[Q.attack2],P2_attack2:y[z.attack2]})),st.complete&&st.naturalWidth>0){const a=st.naturalWidth,g=st.naturalHeight,k=e/n,I=a/g;let q=0,j=0,v=a,M=g;I>k?(v=Math.round(g*k),q=Math.round((a-v)*.5)):(M=Math.round(a/k),j=Math.round((g-M)*.5)),t.drawImage(st,q,j,v,M,0,0,e,n)}else t.fillStyle="#071428",t.fillRect(0,0,e,n);if(f&&(f._frozen||f.update(m,y,ht,ft)),s){s._frozen||s.update(m,y,ht,ft);try{s._aiPauseTimer==null&&(s._aiPauseTimer=.25)}catch{}}if(T){T._frozen||T.update(m,y,ht,ft);try{T._aiPauseTimer==null&&(T._aiPauseTimer=.25)}catch{}}[f,s,T].forEach(a=>{if(!a)return;if(a.name==="P2"&&!a.onGround&&!a.flying&&a.vy===0&&(a.vy=40),a.name==="P2"&&a.y>n+500){const j=Ft();a.y=j-a.h-20,a.x=Math.max(100,Math.min(e-100,a.x)),a.vy=0,a.vx=0,a.onGround=!1,console.error("[qte][physics] EMERGENCY TELEPORT: P2 fell too far, teleporting to safe position. new pos=",{x:a.x,y:a.y})}const g=a.y+a.h-a.vy*m,k=a.y+a.h;try{if(a.onGround&&y[a.keys.down]){a.onGround=!1,a.vy=Math.max(a.vy,40);try{}catch{}}}catch{}let I=!1;if(gt&&tt&&tt.width>0&&st&&st.naturalWidth>0)try{const j=st.naturalWidth,v=st.naturalHeight,M=e/n,B=j/v;let Y=0,Z=0,ot=j,at=v;B>M?(ot=Math.round(v*M),Y=Math.round((j-ot)*.5)):(at=Math.round(j/M),Z=Math.round((v-at)*.5));const It=a.x+a.w*.5,S=Math.floor(Y+It/e*ot),C=Math.floor(Z+g/n*at),W=Math.floor(Z+k/n*at);if(a.vy>=0&&W>=C)for(let rt=C;rt<=W;rt++){if(rt<0||rt>=tt.height||S<0||S>=tt.width)continue;if(gt.getImageData(S,rt,1,1).data[3]>128){if(y[a.keys.down])break;const nt=(rt-Z)/at*n;typeof a.landAt=="function"?a.landAt(nt-a.h):(a.y=nt-a.h,a.vy=0,a.onGround=!0);try{}catch{}I=!0;break}}}catch(j){console.warn("[qte] heatmap sampling failed, falling back to platform AABB",j)}if(!I){let j=null,v=-1/0;for(const M of Ct.platforms)a.x+a.w>M.x&&a.x<M.x+M.w&&k>=M.y&&g<=M.y&&a.vy>=0&&M.y>v&&(j=M,v=M.y);if(j)y[a.keys.down]||(typeof a.landAt=="function"?a.landAt(j.y-a.h):(a.y=j.y-a.h,a.vy=0,a.onGround=!0));else if(oe){const M=Ft();a.vy>=0&&k>=M&&g<=M&&(typeof a.landAt=="function"?a.landAt(M-a.h):(a.y=M-a.h,a.vy=0,a.onGround=!0),console.warn("[qte][physics] EMERGENCY FALLBACK: Using virtual ground at main platform level for",a.name))}}try{if(a.onGround){const j=Math.floor(a.y+a.h+1),v=3;let M=!1;const B=[];for(let Y=0;Y<v;Y++){const Z=Math.floor(a.x+2+Y/(v-1)*Math.max(0,a.w-4)),ot=Lt(Z,j);if(B.push({x:Z,supported:ot}),ot){M=!0;break}}if(!M){a.onGround=!1,a.vy=Math.max(a.vy,40);try{}catch{}}}}catch{}if(a.y>Ct.fallThreshold){const j="fell off stage",v=a===f?s:f;if(a.name==="P1")if(console.log(`[qte] P1 ${j} — respawning and losing a stock`),a.stocks=typeof a.stocks=="number"?Math.max(0,a.stocks-1):0,a.stocks<=0)a.state="defeat",a.attacking1=!1,a.attacking2=!1,a.parrying=!1,a.ranging1=!1,a.ranging2=!1,a.vx=0,a.vy=0,a.anim&&typeof a.anim.setState=="function"&&a.anim.setState("defeat"),K()||(Wt=!0,$t=v||null),console.log(`[qte] P1 has no stocks left — ${(v==null?void 0:v.name)||"unknown"} wins`);else{try{const M=Mt[E]||Mt[1]||null;if(M){se(M),console.log(`[qte] P1 respawned in section ${E} (not resetting to section 1)`);const B=M.spawn_points&&M.spawn_points.find(Y=>Y.name==="player_start");if(B){const Y=Tt(B.x,B.y);Y.y-=250,a.x=Y.x,a.y=Y.y,console.log(`[qte] P1 respawned at section ${E} spawn point:`,B,"->",Y)}else{const Y=Ft();a.x=100,a.y=Y-a.h,console.log(`[qte] P1 respawned at fallback position in section ${E}`)}if(s&&E===1){const Y=M.spawn_points&&M.spawn_points.find(Z=>Z.name==="npc_spawn_1");if(Y){const Z=Tt(Y.x,Y.y);Z.y-=250,s.x=Z.x,s.y=Z.y,s.vx=0,s.vy=0,s.facing=-1,console.log(`[qte] P2 (NPC1) respawned at section ${E} spawn point:`,Y,"->",Z)}}else E>1&&console.log(`[qte] P2 (NPC1) not respawned - current section ${E} > 1`)}else{const B=Ft();a.x=100,a.y=B-a.h}}catch{const B=Ft();a.x=100,a.y=B-a.h}a.vx=0,a.vy=0,a.damagePercent=0,a.launchedFromHit=!1,a.hurt=!1,a.hurtTimer=0,a.stunTimer=0}else{a.state="defeat";try{L=null,O=null,a.name==="P2"&&(s=null)}catch{}a.attacking1=!1,a.attacking2=!1,a.parrying=!1,a.ranging1=!1,a.ranging2=!1,a.vx=0,a.vy=0,a.maxHp=0,a.hp=0,a.anim&&typeof a.anim.setState=="function"&&a.anim.setState("defeat"),K()||(Wt=!0,$t=f||null)}}});try{!wt&&E===1&&f&&f.x>e&&re(2,"right")}catch{}ht.forEach(a=>a.update(m)),ft.forEach(a=>a.update(m));for(let a=ht.length-1;a>=0;a--)ht[a].alive||ht.splice(a,1);for(let a=ft.length-1;a>=0;a--)ft[a].alive||ft.splice(a,1);try{if(s&&typeof s._corpseTimer=="number"&&(s._corpseTimer=Math.max(0,s._corpseTimer-m),s._corpseTimer<=0)){try{L=null}catch{}try{O=null}catch{}s=null}}catch{}if(f||s||T){f&&f.draw(),s&&s.draw(),T&&(T.x>=-100&&T.x<=e+100&&T.y>=-100&&T.y<=n+100||console.log(`[qte] ⚠️ Granny outside visible bounds: (${T.x}, ${T.y}) - Canvas: ${e}x${n}`),T.draw());try{if(s&&s.shouldRemove){console.log("[qte] Removing defeated NPC (P2) from game"),s=null;try{O=null}catch{}try{L=null}catch{}}if(T&&T.shouldRemove){console.log("[qte] Removing defeated Granny NPC from game"),T=null;try{mt=null}catch{}}}catch{}try{if(s&&s.pendingAttackEffect){const a=s.pendingAttackEffect;if(a&&a.rects&&a.image){if(a.waitForAttack){const g=s.anim,k=g&&g.state,I=g&&typeof g.frame=="number"?g.frame:-1,q=typeof a.spawnFrame=="number"?a.spawnFrame:0;k==="attack1"&&I>=q&&(a.waitForAttack=!1,a.elapsed=0)}if(!a.waitForAttack){a.elapsed=(a.elapsed||0)+m;const g=a.fps||12,k=a.frames||a.rects&&a.rects.length||1,I=Math.min(k-1,Math.floor(a.elapsed*g)),q=a.rects[I];let j=!1;try{const v=s.anim&&s.anim.animations&&s.anim.animations.attack1;if(s.anim&&s.anim.state==="attack1"&&v&&v.rects&&v.rects.length>0&&v.image&&v.image===a.image){const B=typeof s.anim.frame=="number"?s.anim.frame:-1,Y=v.rects[B],Z=q;if(Y&&Z&&B===I&&Y.x===Z.x&&Y.y===Z.y&&Y.w===Z.w&&Y.h===Z.h&&(j=!0,a.elapsed>=k/g))try{delete s.pendingAttackEffect}catch{}}}catch{}if(!j){const v=s.x+s.w*.5-q.w*.5,M=s.y-q.h-8;if((s.facing||1)<0)try{t.save(),t.translate(v+q.w,0),t.scale(-1,1),t.drawImage(a.image,q.x,q.y,q.w,q.h,0,M,q.w,q.h),t.restore()}catch{t.drawImage(a.image,q.x,q.y,q.w,q.h,v,M,q.w,q.h)}else t.drawImage(a.image,q.x,q.y,q.w,q.h,v,M,q.w,q.h)}if(a.elapsed>=k/g)try{delete s.pendingAttackEffect}catch{}}}else try{delete s.pendingAttackEffect}catch{}}}catch{}if(ht.forEach(a=>a.draw(t)),ft.forEach(a=>a.draw(t)),_t.complete&&_t.naturalWidth>0)try{const a=_t.naturalWidth,g=_t.naturalHeight,k=e/n,I=a/g;let q=0,j=0,v=a,M=g;I>k?(v=Math.round(g*k),q=Math.round((a-v)*.5)):(M=Math.round(a/k),j=Math.round((g-M)*.5)),t.drawImage(_t,q,j,v,M,0,0,e,n)}catch{}f&&(he(t,20,20,f.damagePercent,f.stocks??3,f.color,"P1"),fe(t,20,46,f.parryCooldown??0,3,f.color)),s&&(he(t,e-220,20,s.damagePercent,s.stocks??3,s.color,"P2"),fe(t,e-220,46,s.parryCooldown??0,3,s.color)),f&&f.parrying&&me(t,f.x+f.w/2,f.y-20,f.parryTimer,f.parryDurationDefault,0,f.color),s&&s.parrying&&me(t,s.x+s.w/2,s.y-20,s.parryTimer,s.parryDurationDefault,0,s.color)}if(!K()&&Wt&&$t&&Te(t,e,n,$t),wt){if(qt==="fade_out")kt=Math.min(1,kt+m/.4),kt>=1-1e-6&&Et&&!zt&&!Xt&&(Xt=be(Et).then(()=>{console.log(`[qte] 🔄 Assets ready - updating currentSectionIdx: ${E} -> ${St}`),E=St,zt=!0;try{Qt==="right"?f&&(f.x=4):Qt==="left"&&f&&(f.x=e-4),f&&(f.vx=0,f.vy=0,f.onGround=!1),s&&(s.vx=0,s.vy=0)}catch{}Et=null,Xt=null,qt="fade_in"}).catch(()=>{zt=!0,Xt=null,qt="fade_in"}));else if(qt==="fade_in"&&(kt=Math.max(0,kt-m/.4),kt<=0+1e-6)){kt=0,qt=null,wt=!1;try{f&&(f._frozen=!1)}catch{}try{s&&(s._frozen=!1)}catch{}try{T&&(T._frozen=!1)}catch{}}try{t.save();const g=Math.max(0,Math.min(1,kt));t.fillStyle=`rgba(0,0,0,${g})`,t.fillRect(0,0,e,n),t.restore()}catch{}}if(f&&s){const a=f.hitbox(),g=s.hitbox();if(a&&Bt(a,s.rect())&&(f.attacking1||f.attacking2)){const k=f.attacking1?"attack1Launched":"attack2Launched";if(!f[k]){if(f[k]=!0,s.parrying&&!s.parryConsumed)s.parryConsumed=!0,s.parryFreezeTimer=.15,f.ranging1||f.ranging2?console.log("[qte] P2 successfully ranged-parried P1's ranged attack: damage negated"):(console.log("[qte] P2 successfully attack-parried P1's melee attack: reflecting"),f.receiveHit(20,120,1,s.x<f.x?Math.PI:0));else if(!s.parrying||s.parryConsumed)if(!!L)try{s&&typeof s.takeDamage=="function"&&s.takeDamage(Math.ceil((s.maxHp||1)/3))}catch{}else s.receiveHit(30,140,.6,f.x<s.x?Math.PI:0)}}if(g&&Bt(g,f.rect())&&(s.attacking1||s.attacking2)){const k=s.attacking1?"attack1Launched":"attack2Launched";if(!s[k]){if(s[k]=!0,f.parrying&&!f.parryConsumed)f.parryConsumed=!0,f.parryFreezeTimer=.15,s.ranging1||s.ranging2?console.log("[qte] P1 successfully ranged-parried P2's ranged attack: damage negated"):(console.log("[qte] P1 successfully attack-parried P2's melee attack: reflecting"),s.receiveHit(20,120,1,f.x<s.x?Math.PI:0));else if(!f.parrying||f.parryConsumed)if(!!L)try{f&&typeof f.takeDamage=="function"&&f.takeDamage(Math.ceil((f.maxHp||1)/3))}catch{}else f.receiveHit(30,140,.6,s.x<f.x?Math.PI:0)}}for(const k of ht)if(k.alive){try{const I=k.rect(),q=I.x+I.w*.5,j=I.y+I.h;if(Lt(q,j)){let v=null,M=null,B=4;k.owner&&k.owner.name==="P1"&&ut&&ut.animations.blast?(v=ut.image,M=ut.animations.blast.frames,B=ut.animations.blast.frames.length):k.owner&&k.owner.name==="P2"&&yt&&yt.animations.blast&&(v=yt.image,M=yt.animations.blast.frames,B=yt.animations.blast.frames.length),ft.push(new Gt(q,j,k.owner&&k.owner.name==="P1"?Rt:Dt,B,v,M)),k.alive=!1;continue}}catch{}if(k.alive){if(k.owner!==f&&Bt(k.rect(),f.rect())){if(f.parrying&&!f.parryConsumed)f.parryConsumed=!0,f.parryFreezeTimer=.15,k.owner.stunTimer=1.2,k.alive=!1,console.log("[qte] P1 successfully parried P2's projectile! (parry window active)");else if(!f.parrying||f.parryConsumed){try{const v=Math.max(1,Math.ceil((f.maxHp||1)/12));typeof f.takeDamage=="function"&&f.takeDamage(v)}catch{}k.applyKnockbackOnHit?f.receiveHit(8,90,.9,k.vx<0?Math.PI:0):(f.damagePercent+=8,console.log(`[qte] ${f.name} percent increased to ${f.damagePercent}`)),k.alive=!1}console.debug("[qte] projectile hit P1",{projectileSrc:(J=k.anim.animations.fly)==null?void 0:J.src,blastSrc:Dt});let I=null,q=null,j=4;yt&&yt.animations.blast?(I=yt.image,q=yt.animations.blast.frames,j=yt.animations.blast.frames.length,console.log("[qte] Blast using atlas frames from cyboard")):console.log("[qte] Blast: No atlas frames for 'blast' in cyboard, falling back to individual image.");try{const v=k.rect(),M=v.x+v.w*.5,B=v.y+v.h*.5;ft.push(new Gt(M,B,Dt,j,I,q))}catch{ft.push(new Gt(f.x+f.w*.5,f.y+f.h*.5,Dt,j,I,q))}}if(k.owner!==s&&Bt(k.rect(),s.rect())){if(s.parrying&&!s.parryConsumed)s.parryConsumed=!0,s.parryFreezeTimer=.15,k.owner.stunTimer=1.2,k.alive=!1,console.log("[qte] P2 successfully parried P1's projectile! (parry window active)");else if(!s.parrying||s.parryConsumed){try{const v=Math.max(1,Math.ceil((s.maxHp||1)/12));typeof s.takeDamage=="function"&&s.takeDamage(v)}catch{}k.applyKnockbackOnHit?s.receiveHit(8,90,.9,k.vx<0?Math.PI:0):(s.damagePercent+=8,console.log(`[qte] ${s.name} percent increased to ${s.damagePercent}`)),k.alive=!1}console.debug("[qte] projectile hit P2",{projectileSrc:(D=k.anim.animations.fly)==null?void 0:D.src,blastSrc:Rt});let I=null,q=null,j=4;ut&&ut.animations.blast?(I=ut.image,q=ut.animations.blast.frames,j=ut.animations.blast.frames.length,console.log("[qte] Blast using atlas frames from ninja")):console.log("[qte] Blast: No atlas frames for 'blast' in ninja, falling back to individual image.");try{const v=k.rect(),M=v.x+v.w*.5,B=v.y+v.h*.5;ft.push(new Gt(M,B,Rt,j,I,q))}catch{ft.push(new Gt(s.x+s.w*.5,s.y+s.h*.5,Rt,j,I,q))}}}}f.isDefeated()&&f.state!=="defeat"&&(f.state="defeat",f.attacking1=!1,f.attacking2=!1,f.parrying=!1,f.ranging1=!1,f.ranging2=!1,f.vx=0,f.vy=0,f.anim.setState("defeat"),K()||(Wt=!0,$t=s),console.log("[qte] P1 DEFEATED! P2 WINS!")),s.isDefeated()&&s.state!=="defeat"&&(s.state="defeat",s.attacking1=!1,s.attacking2=!1,s.parrying=!1,s.ranging1=!1,s.ranging2=!1,s.vx=0,s.vy=0,s.anim.setState("defeat"),K()||(Wt=!0,$t=f),console.log("[qte] P2 DEFEATED! P1 WINS!"))}requestAnimationFrame(te)}requestAnimationFrame(te);function Bt(r,m){return!(r.x+r.w<m.x||m.x+m.w<r.x||r.y+r.h<m.y||m.y+m.h<r.y)}function he(r,m,w,y,F,J,D){r.fillStyle="#333",r.fillRect(m,w,160,20);const k=Math.min(100,y)/100;r.fillStyle=J,r.fillRect(m,w,160*k,20),r.strokeStyle="#fff",r.lineWidth=2,r.strokeRect(m,w,160,20),r.fillStyle="#fff",r.font="12px Arial",r.fillText(`${D} ${Math.round(y)}% (${F})`,m,w-5)}function fe(r,m,w,y,F,J){r.fillStyle="#222",r.fillRect(m,w,160,8);const g=Math.max(0,Math.min(1,y/F));r.fillStyle=g>0?"rgba(200,50,50,0.9)":"rgba(50,200,50,0.9)",r.fillRect(m,w,160*(1-g),8),r.strokeStyle="#000",r.lineWidth=1,r.strokeRect(m,w,160,8),r.fillStyle="#fff",r.font="10px Arial";const k=y>0?`${y.toFixed(1)}s`:"Ready";r.fillText(k,m+160+6,w+8)}function me(r,m,w,y,F,J,D){r.fillStyle="#333",r.fillRect(m-60/2,w,60,8);const k=(F-y)/F;r.fillStyle=D,r.fillRect(m-60/2,w,60*k,8);const I=(F-J)/F,q=1,j=m-60/2+60*I,v=60*(q-I);r.fillStyle="rgba(255, 255, 0, 0.3)",r.fillRect(j,w,v,8),r.strokeStyle="#fff",r.lineWidth=1,r.strokeRect(m-60/2,w,60,8),r.fillStyle="#fff",r.font="10px Arial",r.textAlign="center",r.fillText("PARRY",m,w-5),r.textAlign="left"}function Te(r,m,w,y){r.fillStyle="rgba(0, 0, 0, 0.7)",r.fillRect(0,0,m,w),r.fillStyle="#fff",r.font="bold 48px Arial",r.textAlign="center",r.fillText("GAME OVER",m/2,w/2-60),r.fillStyle=y.color,r.font="bold 36px Arial",r.fillText(`${y.name} WINS!`,m/2,w/2),r.fillStyle="#ccc",r.font="24px Arial",r.fillText("Press F5 to restart",m/2,w/2+60),r.textAlign="left"}return{ctx:t,p1:f,p2:s}}document.addEventListener("DOMContentLoaded",async()=>{const d=document.getElementById("gameCanvas"),t=document.getElementById("loadingScreen"),e=document.getElementById("loadingProgress"),n=document.getElementById("loadingText");if(!d){console.error("Game canvas not found!");return}try{n.textContent="Initializing game engine...",e.style.width="20%",await new Promise(x=>setTimeout(x,500)),n.textContent="Loading assets...",e.style.width="60%";const{p1:o,p2:p}=Ee(d);n.textContent="Starting game...",e.style.width="100%",setTimeout(()=>{t&&t.classList.add("hidden")},500),window.__qte={p1:o,p2:p},console.log("QTE Fighting Game initialized successfully!"),console.log("Controls:"),console.log("P1: WASD (move), E/Q (attacks), R (parry), T/Y (ranged)"),console.log("P2: Arrow keys (move), Numpad 1-5 (attacks/parry)")}catch(o){console.error("Failed to initialize game:",o),n&&(n.textContent="Failed to load game. Check console for details.")}});
